---
title: "Airborne eDNA Size-Fraction Analysis"
output: html_notebook
---

This notebook reports the full size-fraction airborne eDNA analysis used for the manuscript. It starts from processed sequencing and metadata tables and generates the quantitative summaries, statistical models, and figures used to interpret biological patterns across aerosol size classes and seasons.

The workflow follows the analytical logic of the study: establish sequencing quality and control behavior, evaluate and remove contaminants, quantify richness and composition patterns across size fractions, integrate molecular data with optical bioaerosol observations, and provide meteorological and deposition context.

## 1) Analysis setup

This section loads the packages used throughout the manuscript and prepares output folders for tables and figures. All derived outputs are written to disk so the full workflow remains inspectable and reproducible for reviewers.

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(readxl)
library(lubridate)
library(vegan)
library(iNEXT)
library(fuzzyjoin)
library(zoo)
library(broom)
library(car)
library(suncalc)

theme_set(theme_bw(base_size = 11))

fig_dir <- here("Figures", "data_analysis_clean")
derived_dir <- here("Data", "derived")

dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(derived_dir, recursive = TRUE, showWarnings = FALSE)
```

## 2) Load manuscript input data

The notebook reads the core processed input data tables directly from the repository. These include the ASV abundance matrix, taxonomic assignments and assignment confidence, sample metadata, DNA concentration measurements, Biotrack optical particle measurements, meteorological observations, and deposition-speed input values.

```{r load-data}
asv_table_raw <- read_tsv(here("Data", "COI_ASW_glom.txt"), show_col_types = FALSE)
taxonomy_table_raw <- read_tsv(here("Data", "COI_taxa_80_glom.txt"), show_col_types = FALSE)
taxonomy_probabilities <- read_tsv(here("Data", "COI_Sintax_prob.txt"), show_col_types = FALSE)
sample_metadata_raw <- read_tsv(here("Data", "sample_meta.tsv"), show_col_types = FALSE)
dna_concentration <- read_tsv(here("Data", "DNA_concentration_HS.txt"), show_col_types = FALSE)

biotrack_20201006 <- read_excel(here("Data", "Hyltemossa_20201006.xlsx"))
biotrack_20201022 <- read_excel(here("Data", "Hyltemossa_20201022.xlsx"))
biotrack_20210428 <- read_excel(here("Data", "Hyltemossa_20210428.xlsx"))
biotrack_20210524 <- read_excel(here("Data", "Hyltemossa_20210524.xlsx"))

weather_30m_raw <- read_delim(
  here("Data", "ICOS", "My data cart", "ICOS_ATC_NRT_HTM_2021-02-01_2022-02-28_30.0_612.MTO"),
  delim = ";",
  skip = 38,
  show_col_types = FALSE
)

precip_raw <- read_delim(
  here("Data", "ICOS", "SE-Htm_meteo_2020_CP_flag.txt"),
  delim = ",",
  show_col_types = FALSE
)

deposition_raw <- read_tsv(here("Data", "deposition_speed.txt"), show_col_types = FALSE)

tibble(
  table = c(
    "asv_table_raw", "taxonomy_table_raw", "taxonomy_probabilities",
    "sample_metadata_raw", "dna_concentration", "weather_30m_raw"
  ),
  rows = c(
    nrow(asv_table_raw), nrow(taxonomy_table_raw), nrow(taxonomy_probabilities),
    nrow(sample_metadata_raw), nrow(dna_concentration), nrow(weather_30m_raw)
  ),
  cols = c(
    ncol(asv_table_raw), ncol(taxonomy_table_raw), ncol(taxonomy_probabilities),
    ncol(sample_metadata_raw), ncol(dna_concentration), ncol(weather_30m_raw)
  )
)
```

## 3) Prepare sample metadata for ecological comparisons

Sample metadata are harmonized into an analysis-ready table with parsed start/end times, season assignment, and mapped NGI size-fraction labels in aerodynamic diameter classes. This table provides the primary design structure for downstream comparisons across size fractions and between fall and spring campaigns.

```{r metadata-prep}
sample_metadata <- sample_metadata_raw %>%
  rename(Sample = Sample_ID) %>%
  mutate(
    Start_Date = ymd_hms(Start_Date, truncated = 3),
    End_Date = ymd_hms(End_Date, truncated = 3),
    season = case_when(
      Start_Date < ymd("2020-11-01") ~ "Fall",
      TRUE ~ "Spring"
    ),
    Time_h = as.numeric(Time_h),
    Time_h = case_when(
      is.na(Time_h) ~ as.numeric(difftime(End_Date, Start_Date, units = "hours")),
      TRUE ~ Time_h
    ),
    Type = case_when(
      is.na(Blank) ~ Type,
      TRUE ~ Blank
    ),
    SizeFrac = as.character(SizeFrac),
    SizeFrac = dplyr::recode(
      SizeFrac,
      "1" = "8.83",
      "2" = "4.89",
      "3" = "3.09",
      "4" = "1.82",
      "5" = "1.03",
      "6" = "0.60",
      "7" = "0.37",
      "8" = "< 0.37"
    ),
    SizeFrac = factor(SizeFrac, levels = c("< 0.37", "0.37", "0.60", "1.03", "1.82", "3.09", "4.89", "8.83"))
  ) %>%
  filter(Sample %in% asv_table_raw$Sample)

sample_metadata %>%
  write_tsv(here(derived_dir, "sample_metadata_prepared.tsv"))

sample_metadata %>%
  count(Type, season, SizeFrac, sort = TRUE)
```

## 4) Read-depth quality assessment and manuscript reporting statistics

This section evaluates library yield across positive samples and negative controls. The goal is to document sequencing depth distributions in a form that can be reported in the Methods/Results text, and to identify potential outliers such as low-read positive samples or high-read controls.

```{r read-summary}
control_samples <- c("Extr_Bl", "S55", "S64", "S81")
low_positive_threshold <- 5000
high_control_threshold <- 5000

sample_read_summary <- asv_table_raw %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  summarise(
    total_reads = sum(reads),
    n_detected_seq = sum(reads > 0),
    .groups = "drop"
  ) %>%
  left_join(sample_metadata, by = "Sample") %>%
  left_join(dna_concentration, by = "Sample") %>%
  mutate(
    sample_class = case_when(
      Sample %in% control_samples ~ "Negative control",
      Type == "Blank" ~ "Negative control",
      TRUE ~ "Positive sample"
    )
  )

sample_read_summary %>%
  write_tsv(here(derived_dir, "sample_read_summary.tsv"))

read_depth_stats <- sample_read_summary %>%
  group_by(sample_class) %>%
  summarise(
    n_samples = n(),
    mean_reads = mean(total_reads),
    median_reads = median(total_reads),
    min_reads = min(total_reads),
    max_reads = max(total_reads),
    .groups = "drop"
  )

read_depth_flags <- sample_read_summary %>%
  mutate(
    qc_flag = case_when(
      sample_class == "Positive sample" & total_reads < low_positive_threshold ~ "Low-read positive",
      sample_class == "Negative control" & total_reads >= high_control_threshold ~ "High-read control",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(qc_flag)) %>%
  select(Sample, sample_class, Type, season, total_reads, n_detected_seq, qc_flag)

method_read_stats <- sample_read_summary %>%
  summarise(
    n_positive_samples = sum(sample_class == "Positive sample"),
    n_negative_controls = sum(sample_class == "Negative control"),
    mean_reads_positive = mean(total_reads[sample_class == "Positive sample"]),
    median_reads_positive = median(total_reads[sample_class == "Positive sample"]),
    mean_reads_controls = mean(total_reads[sample_class == "Negative control"]),
    median_reads_controls = median(total_reads[sample_class == "Negative control"]),
    n_low_read_positive = sum(sample_class == "Positive sample" & total_reads < low_positive_threshold),
    n_high_read_controls = sum(sample_class == "Negative control" & total_reads >= high_control_threshold)
  ) %>%
  pivot_longer(cols = everything(), names_to = "metric", values_to = "value")

read_depth_stats %>%
  write_tsv(here(derived_dir, "read_depth_summary_by_class.tsv"))
read_depth_flags %>%
  write_tsv(here(derived_dir, "read_depth_qc_flags.tsv"))
method_read_stats %>%
  write_tsv(here(derived_dir, "method_read_depth_stats.tsv"))

list(
  summary_by_class = read_depth_stats,
  method_reporting_stats = method_read_stats,
  flagged_samples = read_depth_flags
)
```

```{r read-depth-interpretation}
method_read_stats_wide <- method_read_stats %>%
  pivot_wider(names_from = metric, values_from = value)

cat(
  "Sequencing depth summary:\\n",
  "- Positive samples:", method_read_stats_wide$n_positive_samples, "\\n",
  "- Negative controls:", method_read_stats_wide$n_negative_controls, "\\n",
  "- Mean reads in positive samples:", round(method_read_stats_wide$mean_reads_positive), "\\n",
  "- Median reads in positive samples:", round(method_read_stats_wide$median_reads_positive), "\\n",
  "- Mean reads in controls:", round(method_read_stats_wide$mean_reads_controls), "\\n",
  "- Median reads in controls:", round(method_read_stats_wide$median_reads_controls), "\\n",
  "- Low-read positive samples (<", low_positive_threshold, "reads):", method_read_stats_wide$n_low_read_positive, "\\n",
  "- High-read controls (>=", high_control_threshold, "reads):", method_read_stats_wide$n_high_read_controls, "\\n"
)
```

The rank plot below visualizes sequencing depth spread within positive and control classes, and includes reference lines marking the thresholds used above for low-read positives and high-read controls.

```{r read-depth-rank-plot}
plot_reads_rank <- sample_read_summary %>%
  arrange(desc(total_reads)) %>%
  mutate(rank = row_number()) %>%
  ggplot(aes(rank, total_reads, colour = sample_class)) +
  geom_point() +
  scale_y_log10() +
  geom_hline(yintercept = c(low_positive_threshold, high_control_threshold), linetype = "dashed") +
  facet_wrap(~sample_class, scales = "free_x") +
  scale_color_manual(values = c("Positive sample" = "#025196", "Negative control" = "#D1495B")) +
  labs(x = "Sample rank by read count", y = "Total reads", colour = NULL)

plot_reads_rank

ggsave(
  filename = here(fig_dir, "qc_reads_by_sample_rank.png"),
  plot = plot_reads_rank,
  width = 7,
  height = 4,
  dpi = 300
)
```

DNA concentration and sequencing depth are plotted together for positive samples to show how extraction yield and sequencing yield co-vary across seasons and sample types.

```{r dna-vs-reads}
plot_dna_reads <- sample_read_summary %>%
  filter(sample_class == "Positive sample") %>%
  filter(!is.na(DNA_C)) %>%
  ggplot(aes(DNA_C, total_reads + 1, colour = season)) +
  geom_point() +
  facet_wrap(~Type) +
  scale_y_log10() +
  geom_hline(yintercept = 2e4, linetype = "dashed") +
  labs(x = "DNA concentration", y = "Reads")

plot_dna_reads

ggsave(
  filename = here(fig_dir, "qc_dna_vs_reads.png"),
  plot = plot_dna_reads,
  width = 7,
  height = 4,
  dpi = 300
)
```

## 5) Contaminant assessment and removal

This section applies three contaminant checks: (i) sequences observed in the extraction blank, (ii) sequences observed in process blanks, and (iii) sequences taxonomically assigned to human. The union of these candidates is removed from all samples. Control samples are summarized before and after filtering to document whether high-read controls are dominated by candidate contaminants and how much residual signal remains.

```{r contaminant-checks}
extraction_blank_sequences <- asv_table_raw %>%
  filter(Sample == "Extr_Bl") %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  pull(seq)

human_sequences <- taxonomy_table_raw %>%
  filter(genus == "Homo") %>%
  pull(seq)

process_blank_sequences <- asv_table_raw %>%
  filter(Sample %in% control_samples[control_samples != "Extr_Bl"]) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  pull(seq)

sequences_to_remove <- unique(c(extraction_blank_sequences, human_sequences, process_blank_sequences))

contaminant_catalog <- bind_rows(
  tibble(seq = extraction_blank_sequences, source = "Extraction blank"),
  tibble(seq = process_blank_sequences, source = "Process blanks"),
  tibble(seq = human_sequences, source = "Human assignment")
) %>%
  distinct()

control_contaminant_accounting <- asv_table_raw %>%
  filter(Sample %in% control_samples) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  mutate(
    contaminant_flag = case_when(
      seq %in% sequences_to_remove ~ "candidate_contaminant",
      TRUE ~ "not_flagged"
    )
  ) %>%
  group_by(Sample, contaminant_flag) %>%
  summarise(
    reads = sum(reads),
    n_seq = n(),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = contaminant_flag, values_from = c(reads, n_seq), values_fill = 0) %>%
  mutate(
    prop_reads_candidate_contaminant = reads_candidate_contaminant / (reads_candidate_contaminant + reads_not_flagged)
  )

contaminant_catalog %>%
  write_tsv(here(derived_dir, "contaminant_catalog.tsv"))
control_contaminant_accounting %>%
  write_tsv(here(derived_dir, "control_contaminant_accounting_before_filter.tsv"))

list(
  contaminant_sequence_sources = contaminant_catalog %>% count(source),
  control_accounting_before_filter = control_contaminant_accounting
)
```

```{r remove-contaminants}
asv_table_clean <- asv_table_raw %>%
  select(-any_of(sequences_to_remove))

taxonomy_table_clean <- taxonomy_table_raw %>%
  filter(seq %in% colnames(asv_table_clean))

tibble(seq_removed = sequences_to_remove) %>%
  write_tsv(here(derived_dir, "removed_sequences.tsv"))
asv_table_clean %>%
  write_tsv(here(derived_dir, "asv_table_clean.tsv"))
taxonomy_table_clean %>%
  write_tsv(here(derived_dir, "taxonomy_table_clean.tsv"))

control_after_filter <- asv_table_clean %>%
  filter(Sample %in% control_samples) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  summarise(
    reads_remaining = sum(reads),
    n_seq_remaining = sum(reads > 0),
    .groups = "drop"
  )

control_after_filter %>%
  write_tsv(here(derived_dir, "control_signal_after_filter.tsv"))

contaminant_removal_summary <- tibble(
  metric = c("raw_sequences", "removed_sequences", "clean_sequences"),
  n = c(ncol(asv_table_raw) - 1, length(sequences_to_remove), ncol(asv_table_clean) - 1)
)

contaminant_removal_summary
control_after_filter
```

```{r contaminant-interpretation}
control_after_summary <- control_after_filter %>%
  summarise(
    n_controls = n(),
    n_controls_with_residual_reads = sum(reads_remaining > 0),
    max_residual_reads = max(reads_remaining),
    median_residual_reads = median(reads_remaining)
  )

control_before_summary <- control_contaminant_accounting %>%
  summarise(
    mean_prop_candidate_contaminant = mean(prop_reads_candidate_contaminant),
    min_prop_candidate_contaminant = min(prop_reads_candidate_contaminant),
    max_prop_candidate_contaminant = max(prop_reads_candidate_contaminant)
  )

cat(
  "Contaminant filtering summary in controls:\\n",
  "- Mean proportion of control reads flagged as candidate contaminants before filtering:",
  round(control_before_summary$mean_prop_candidate_contaminant, 3), "\\n",
  "- Range across controls:",
  paste0(round(control_before_summary$min_prop_candidate_contaminant, 3), " to ",
         round(control_before_summary$max_prop_candidate_contaminant, 3)), "\\n",
  "- Controls with residual reads after filtering:",
  control_after_summary$n_controls_with_residual_reads, "of", control_after_summary$n_controls, "\\n",
  "- Median residual reads in controls after filtering:",
  round(control_after_summary$median_residual_reads), "\\n",
  "- Maximum residual reads in controls after filtering:",
  round(control_after_summary$max_residual_reads), "\\n"
)
```

## 6) Taxonomic composition across NGI size fractions

Taxonomic composition is summarized across ranks for NGI samples and used to produce phylum-level composition figures for major airborne groups. The phylum plot focuses on Ascomycota, Basidiomycota, and Arthropoda because these groups represent dominant biological signals for manuscript interpretation.

```{r taxa-distribution}
ngi_taxa_distribution <- asv_table_clean %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI") %>%
  left_join(taxonomy_table_clean, by = "seq") %>%
  pivot_longer(
    cols = c("kingdom", "phylum", "class", "order", "family", "genus", "species"),
    names_to = "rank",
    values_to = "taxa"
  ) %>%
  left_join(
    taxonomy_probabilities %>%
      pivot_longer(-seq, names_to = "rank", values_to = "probability"),
    by = c("seq", "rank")
  ) %>%
  mutate(
    taxa = replace_na(taxa, "not assigned"),
    probability = if_else(taxa == "not assigned", NA_real_, probability)
  ) %>%
  group_by(Sample, rank, taxa, season, probability) %>%
  summarise(n_otu = n(), .groups = "drop")

ngi_taxa_distribution %>%
  write_tsv(here(derived_dir, "ngi_taxa_distribution.tsv"))
```

```{r phylum-plot}
phylum_focus <- c("Ascomycota", "Basidiomycota", "Arthropoda")

ngi_phylum_relative <- ngi_taxa_distribution %>%
  filter(rank == "phylum", taxa %in% phylum_focus) %>%
  left_join(sample_metadata %>% select(Sample, SizeFrac, season), by = c("Sample", "season")) %>%
  group_by(Sample, SizeFrac, season, taxa) %>%
  summarise(n_otu = sum(n_otu), .groups = "drop") %>%
  group_by(SizeFrac, season, taxa) %>%
  summarise(n_otu = mean(n_otu), .groups = "drop") %>%
  group_by(SizeFrac, season) %>%
  mutate(total_otu = sum(n_otu), relative_otu = n_otu / total_otu) %>%
  ungroup()

phylum_label_df <- ngi_phylum_relative %>%
  distinct(SizeFrac, season, total_otu) %>%
  mutate(total_otu = round(total_otu), y = 0.5)

ngi_phylum_relative %>%
  write_tsv(here(derived_dir, "ngi_relative_phylum_abundance.tsv"))

plot_phylum <- ngi_phylum_relative %>%
  ggplot(aes(SizeFrac, relative_otu, fill = taxa)) +
  geom_col() +
  geom_text(
    data = phylum_label_df,
    aes(y = y, label = total_otu),
    colour = "white",
    inherit.aes = FALSE
  ) +
  facet_grid(~season) +
  scale_fill_manual(values = c("#081A5A", "#E74137", "#DAA520")) +
  labs(
    x = "Aerodynamic diameter D50 (um)",
    y = "Relative abundance of OTUs",
    fill = NULL
  ) +
  theme(legend.position = "bottom")

plot_phylum

ggsave(here(fig_dir, "figure_relative_phylum_abundance.png"), plot = plot_phylum, width = 8, height = 4, dpi = 300)
ggsave(here(fig_dir, "figure_relative_phylum_abundance.pdf"), plot = plot_phylum, width = 8, height = 4)
```

## 7) Rarefaction and coverage-based richness estimates

Rarefaction curves are used to visualize richness accumulation with sequencing depth for major phyla. Coverage-based iNEXT estimates are then used for standardized richness comparisons across seasons and size fractions, reducing bias from uneven read counts.

```{r rarefaction}
main_phyla <- c("Arthropoda", "Ascomycota", "Basidiomycota", "Chordata")

asv_matrix_clean <- asv_table_clean %>%
  column_to_rownames("Sample") %>%
  as.matrix()

asv_matrix_clean <- asv_matrix_clean[rowSums(asv_matrix_clean) > 0, , drop = FALSE]

rarefaction_list <- list()

for (phylum_name in main_phyla) {
  seq_ids <- taxonomy_table_clean %>%
    filter(phylum == phylum_name) %>%
    pull(seq)

  phylum_matrix <- asv_matrix_clean[, intersect(seq_ids, colnames(asv_matrix_clean)), drop = FALSE]
  phylum_matrix <- phylum_matrix[rowSums(phylum_matrix) > 0, , drop = FALSE]

  if (ncol(phylum_matrix) == 0 || nrow(phylum_matrix) == 0) next

  rare_df <- rarecurve(phylum_matrix, step = 200, tidy = TRUE)
  rare_df$Phylum <- phylum_name
  rarefaction_list[[phylum_name]] <- rare_df
}

rarefaction_df <- bind_rows(rarefaction_list) %>%
  rename(size = Sample, Sample = Site)

rarefaction_df %>%
  write_tsv(here(derived_dir, "rarefaction_curves.tsv"))

plot_rarefaction <- rarefaction_df %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI") %>%
  ggplot(aes(size, Species, group = Sample, colour = season)) +
  geom_line(alpha = 0.6) +
  facet_wrap(~Phylum, scales = "free_y") +
  scale_x_continuous(limits = c(0, 2e4)) +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "Reads", y = "OTUs") +
  theme(legend.position = "bottom")

plot_rarefaction

ggsave(here(fig_dir, "figure_rarefaction_curves.png"), plot = plot_rarefaction, width = 8, height = 5, dpi = 300)
```

```{r diversity-estimates, cache=TRUE}
diversity_estimate_list <- list()

for (phylum_name in main_phyla) {
  seq_ids <- taxonomy_table_clean %>%
    filter(phylum == phylum_name) %>%
    pull(seq)

  phylum_matrix <- asv_matrix_clean[, intersect(seq_ids, colnames(asv_matrix_clean)), drop = FALSE]
  phylum_matrix <- phylum_matrix[rowSums(phylum_matrix) > 0, , drop = FALSE]

  if (ncol(phylum_matrix) == 0 || nrow(phylum_matrix) == 0) next

  inext_out <- iNEXT::iNEXT(t(phylum_matrix), datatype = "abundance", q = 0, nboot = 10)

  inext_df <- inext_out$iNextEst$coverage_based %>%
    rename(Sample = Assemblage) %>%
    group_by(Sample) %>%
    filter(SC == 1) %>%
    filter(m == max(m)) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(phylum = phylum_name)

  diversity_estimate_list[[phylum_name]] <- inext_df
}

diversity_estimates <- bind_rows(diversity_estimate_list)

diversity_estimates %>%
  write_tsv(here(derived_dir, "diversity_estimates_iNEXT.tsv"))
```

## 8) Richness trends by size class, season, and DNA concentration

Coverage-standardized richness is analyzed across size fractions and seasons for the target fungal and arthropod phyla. A linear model then quantifies the relative contributions of season, phylum, size fraction, and DNA concentration.

```{r diversity-plots}
diversity_plot_data <- diversity_estimates %>%
  filter(phylum != "Chordata") %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI")

plot_richness_size <- diversity_plot_data %>%
  ggplot(aes(SizeFrac, qD, colour = season)) +
  geom_point(alpha = 0.5, size = 1) +
  geom_line(aes(group = Start_Date), alpha = 0.4, linewidth = 0.3) +
  geom_smooth(aes(group = season), se = FALSE) +
  facet_grid(phylum ~ ., scales = "free") +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "Aerodynamic diameter D50 (um)", y = "OTU richness") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_richness_size

ggsave(here(fig_dir, "figure_richness_by_size_fraction.png"), plot = plot_richness_size, width = 6, height = 7, dpi = 300)

plot_dna_richness <- diversity_plot_data %>%
  left_join(dna_concentration, by = "Sample") %>%
  ggplot(aes(DNA_C, qD, colour = season)) +
  geom_point(alpha = 0.8, size = 0.8) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2, aes(group = interaction(season, SizeFrac))) +
  facet_grid(phylum ~ season, scales = "free_y") +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "DNA concentration", y = "OTU richness")

plot_dna_richness

ggsave(here(fig_dir, "figure_dna_vs_richness.png"), plot = plot_dna_richness, width = 7, height = 6, dpi = 300)
```

```{r diversity-model}
diversity_model <- diversity_plot_data %>%
  left_join(dna_concentration, by = "Sample") %>%
  lm(log(qD) ~ season + phylum + SizeFrac + log10(DNA_C), data = .)

diversity_model_anova <- Anova(diversity_model, type = 2) %>%
  tidy() %>%
  mutate(across(where(is.numeric), ~ signif(.x, 3)))

diversity_model_anova %>%
  write_tsv(here(derived_dir, "diversity_model_anova.tsv"))

diversity_model_anova
```

## 9) Community ordination and dominant sequence patterns

Community structure is visualized with Bray-Curtis NMDS using NGI samples. A sequence heatmap of dominant ASVs per sample complements the ordination by showing broad abundance-pattern contrasts across size fractions and seasons.

```{r nmds}
asv_ngi_matrix <- asv_table_clean %>%
  filter(str_detect(Sample, "^S")) %>%
  column_to_rownames("Sample") %>%
  as.matrix()

asv_ngi_matrix <- asv_ngi_matrix[rowSums(asv_ngi_matrix) > 0, , drop = FALSE]
asv_ngi_matrix <- asv_ngi_matrix[, colSums(asv_ngi_matrix) > 0, drop = FALSE]

ngi_nmds <- vegan::metaMDS(asv_ngi_matrix, distance = "bray", autotransform = TRUE)

nmds_points <- as_tibble(ngi_nmds$points, rownames = "Sample") %>%
  left_join(sample_metadata, by = "Sample")

nmds_points %>%
  write_tsv(here(derived_dir, "nmds_points.tsv"))

plot_nmds <- nmds_points %>%
  filter(SizeFrac != "< 0.37") %>%
  ggplot(aes(MDS1, MDS2, colour = SizeFrac)) +
  geom_point() +
  facet_wrap(~season)

plot_nmds

ggsave(here(fig_dir, "figure_nmds.png"), plot = plot_nmds, width = 7, height = 4, dpi = 300)
```

```{r heatmap-top-seq}
top_sequences_per_sample <- asv_table_clean %>%
  filter(str_detect(Sample, "^S")) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  arrange(desc(reads), .by_group = TRUE) %>%
  slice_head(n = 50) %>%
  ungroup()

heatmap_df <- asv_table_clean %>%
  filter(Sample %in% unique(top_sequences_per_sample$Sample)) %>%
  select(Sample, any_of(unique(top_sequences_per_sample$seq))) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  left_join(sample_metadata, by = "Sample") %>%
  mutate(
    Sample = fct_reorder(Sample, as.numeric(SizeFrac), .desc = TRUE),
    seq = factor(seq)
  )

heatmap_df %>%
  write_tsv(here(derived_dir, "heatmap_top_sequences.tsv"))

plot_heatmap <- heatmap_df %>%
  ggplot(aes(Sample, seq, fill = log10(reads + 1))) +
  geom_tile() +
  facet_wrap(season ~ SizeFrac, scales = "free_x", ncol = 8) +
  scale_fill_viridis_c(na.value = "white") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

plot_heatmap

ggsave(here(fig_dir, "figure_heatmap_top_sequences.png"), plot = plot_heatmap, width = 12, height = 7, dpi = 300)
```

## 10) Process Biotrack optical measurements

Biotrack channel data from the four campaigns are merged into a common table and converted to concentrations per liter. The analysis focuses on channels corresponding to approximately 1-14 um particles to align optical size classes with the sequencing size-fraction framework.

```{r biotrack-prepare}
biotrack_combined <- bind_rows(
  biotrack_20201006 %>% mutate(season = "Fall"),
  biotrack_20201022 %>% mutate(season = "Fall"),
  biotrack_20210428 %>% mutate(season = "Spring"),
  biotrack_20210524 %>% mutate(season = "Spring")
) %>%
  filter(!is.na(Date)) %>%
  select(Date, Time, starts_with("Ch"), FlowStatus, Laser_Status, Vol_L, season) %>%
  pivot_longer(cols = starts_with("Ch"), names_to = "Size_frac", values_to = "count") %>%
  mutate(
    type = case_when(str_detect(Size_frac, "Value") ~ "all", TRUE ~ "bio"),
    Size_frac = str_sub(Size_frac, 1, 3)
  ) %>%
  pivot_wider(names_from = type, values_from = count) %>%
  mutate(
    Date_Time = ymd_hms(paste(Date, str_sub(as.character(Time), 12, 19), sep = "_")),
    Date_Time = round_date(Date_Time, unit = "minute")
  ) %>%
  arrange(Date_Time) %>%
  filter(!Size_frac %in% c("Ch1", "Ch2")) %>%
  mutate(
    Size_frac = dplyr::recode(Size_frac, "Ch3" = "1-3um", "Ch4" = "3-5um", "Ch5" = "5-10um", "Ch6" = "10-14um"),
    bio_per_l = bio / Vol_L,
    Date = floor_date(Date_Time, unit = "day")
  )

biotrack_combined %>%
  write_tsv(here(derived_dir, "biotrack_combined.tsv"))
```

```{r biotrack-day-night}
sun_table <- biotrack_combined %>%
  distinct(Date) %>%
  mutate(lat = 56.0976, lon = 13.4189, date = as.Date(Date)) %>%
  suncalc::getSunlightTimes(data = .) %>%
  transmute(
    Date = date,
    sunrise = hms::as_hms(sunrise),
    sunset = hms::as_hms(sunset)
  )

biotrack_plot_data <- biotrack_combined %>%
  left_join(sun_table, by = "Date") %>%
  mutate(
    HMS = hms::as_hms(Date_Time),
    daytime = case_when(
      HMS < sunrise ~ "night",
      HMS >= sunrise & HMS < sunset ~ "day",
      HMS >= sunset ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  group_by(season, Size_frac) %>%
  mutate(
    bio_h = rollapply(bio_per_l, width = 60, FUN = mean, na.rm = TRUE, fill = NA, partial = TRUE),
    bio_day = rollapply(bio_per_l, width = 720, FUN = mean, na.rm = TRUE, fill = NA, partial = FALSE)
  ) %>%
  ungroup()

biotrack_daynight_blocks <- biotrack_plot_data %>%
  filter(!is.na(daytime)) %>%
  arrange(Date_Time) %>%
  mutate(group = cumsum(daytime != lag(daytime, default = first(daytime)))) %>%
  group_by(group, daytime) %>%
  summarise(start = min(Date_Time), end = max(Date_Time), .groups = "drop") %>%
  filter(end > start)

plot_biotrack_time <- biotrack_plot_data %>%
  ggplot(aes(Date_Time)) +
  geom_rect(
    data = biotrack_daynight_blocks,
    aes(xmin = start, xmax = end, ymin = 0.001, ymax = 500, fill = daytime),
    inherit.aes = FALSE,
    alpha = 0.2
  ) +
  geom_line(aes(y = bio_h, colour = Size_frac), linewidth = 0.6) +
  facet_wrap(~season, scales = "free_x", nrow = 2) +
  scale_y_log10() +
  scale_fill_manual(values = c("day" = "#FDC500", "night" = "#00296B")) +
  labs(y = "Bioaerosol concentration per L", x = NULL, fill = NULL)

plot_biotrack_time

ggsave(here(fig_dir, "figure_biotrack_time_series.png"), plot = plot_biotrack_time, width = 10, height = 5, dpi = 300)
```

## 11) Link NGI filter classes with Biotrack classes

To relate molecular richness and concentration patterns to optical measurements, NGI sample windows are matched to Biotrack observations over the same sampling intervals. Biotrack channels are then grouped to align with NGI aerodynamic size ranges.

```{r match-ngi-biotrack}
ngi_biotrack <- sample_metadata %>%
  filter(Type == "NGI") %>%
  fuzzy_left_join(
    biotrack_combined,
    by = c("Start_Date" = "Date_Time", "End_Date" = "Date_Time"),
    match_fun = list(`<=`, `>=`)
  ) %>%
  group_by(Sample, Size_frac) %>%
  summarise(bio = sum(bio, na.rm = TRUE), .groups = "drop")

matched_dna_biotrack <- ngi_biotrack %>%
  pivot_wider(names_from = Size_frac, values_from = bio) %>%
  mutate(Ch5_6 = `5-10um` + `10-14um`) %>%
  select(Sample, `1-3um`, `3-5um`, Ch5_6) %>%
  pivot_longer(-Sample, names_to = "BT_Size_frac", values_to = "count") %>%
  left_join(sample_metadata %>% select(Sample, SizeFrac), by = "Sample") %>%
  mutate(
    match = case_when(
      SizeFrac %in% c("8.83", "4.89") & BT_Size_frac == "Ch5_6" ~ TRUE,
      SizeFrac == "3.09" & BT_Size_frac == "3-5um" ~ TRUE,
      SizeFrac %in% c("1.82", "1.03") & BT_Size_frac == "1-3um" ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  filter(match)

matched_dna_biotrack %>%
  write_tsv(here("Data", "Matched_DNA_Biotrack.txt"))
matched_dna_biotrack %>%
  write_tsv(here(derived_dir, "matched_dna_biotrack.tsv"))

matched_dna_biotrack
```

```{r biotrack-dna-richness-plots}
plot_dna_vs_biotrack <- matched_dna_biotrack %>%
  left_join(dna_concentration, by = "Sample") %>%
  left_join(sample_metadata, by = "Sample") %>%
  ggplot(aes(log10(count), DNA_C, colour = SizeFrac)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2) +
  labs(x = "log10(Biotrack count)", y = "DNA concentration") +
  scale_color_brewer(palette = "Set1")

plot_dna_vs_biotrack

ggsave(here(fig_dir, "figure_biotrack_vs_dna.png"), plot = plot_dna_vs_biotrack, width = 6, height = 4, dpi = 300)

plot_richness_vs_biotrack <- matched_dna_biotrack %>%
  left_join(diversity_estimates, by = "Sample") %>%
  filter(!is.na(phylum), phylum != "Chordata") %>%
  left_join(sample_metadata, by = "Sample") %>%
  ggplot(aes(count, qD, colour = SizeFrac)) +
  geom_point(alpha = 0.8, size = 0.8) +
  facet_grid(phylum ~ season, scales = "free_y") +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Biotrack count", y = "OTU richness") +
  scale_color_brewer(palette = "Set1")

plot_richness_vs_biotrack

ggsave(here(fig_dir, "figure_biotrack_vs_richness.png"), plot = plot_richness_vs_biotrack, width = 7, height = 6, dpi = 300)
```

## 12) Weather context and wind-direction structure

Meteorological data are cleaned to provide environmental context for the sampling period. A wind-direction summary is included to describe dominant airflow sectors by month, which supports interpretation of temporal shifts in observed airborne biological communities.

```{r weather-clean}
weather_30m <- weather_30m_raw %>%
  select(Year, Month, Day, Hour, AT, RH, WS, WD) %>%
  mutate(date = ymd(paste(Year, Month, Day)))

precip_htm <- precip_raw %>%
  select(date, time, P_1_1_1, Swin_1_2_1, Lwin_1_2_1, Sun_1_1_1, RH_1_1_1, Ta_1_1_1) %>%
  setNames(c("date", "time", "precipitation", "radiation_SW", "radiation_LW", "sunshine_frac", "RH", "Temp")) %>%
  slice(-1) %>%
  mutate(across(-c(date, time), as.numeric))

weather_30m %>%
  write_tsv(here(derived_dir, "weather_30m_clean.tsv"))
precip_htm %>%
  write_tsv(here(derived_dir, "precipitation_clean.tsv"))
```

```{r weather-wind-rose}
wind_rose_df <- weather_30m %>%
  filter(WS > 0, WS < 12) %>%
  mutate(
    WS = round(WS),
    WD = cut_interval(WD, 8),
    WD = factor(WD, labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))
  ) %>%
  count(Month, WS, WD, name = "freq")

wind_rose_df %>%
  write_tsv(here(derived_dir, "wind_rose_counts.tsv"))

plot_wind_rose <- wind_rose_df %>%
  ggplot(aes(WD, freq, fill = WS)) +
  geom_col() +
  coord_polar(start = -0.4) +
  scale_fill_viridis_c() +
  facet_wrap(~Month)

plot_wind_rose

ggsave(here(fig_dir, "figure_wind_rose_by_month.png"), plot = plot_wind_rose, width = 8, height = 6, dpi = 300)
```

## 13) Size-dependent dry deposition trajectories

Dry deposition trajectories are calculated over 72 hours to illustrate how quickly different particle-size classes settle vertically and how far they can travel horizontally under a constant reference wind speed. These trajectories provide a physical interpretation layer for observed size-fraction biological patterns.

```{r deposition}
colnames(deposition_raw) <- c("size", "speed", "distance")

deposition_over_time <- deposition_raw %>%
  transmute(
    size = as.character(size),
    settling_speed = as.numeric(speed)
  ) %>%
  distinct() %>%
  tidyr::crossing(sec = seq(0, 72 * 3600, 3600)) %>%
  mutate(
    hours = sec / 3600,
    distance_m = pmin(settling_speed * sec / 1e6, 100),
    wind_distance_km = sec * 5 / 1000
  )

deposition_over_time %>%
  write_tsv(here(derived_dir, "deposition_over_time.tsv"))

plot_deposition_time <- deposition_over_time %>%
  ggplot(aes(hours, distance_m, colour = factor(size), group = size)) +
  geom_line() +
  labs(
    x = "Time (hours)",
    y = "Settling distance (m)",
    colour = "Particle size"
  )

plot_deposition_time

ggsave(here(fig_dir, "figure_dry_deposition_over_time.png"), plot = plot_deposition_time, width = 7, height = 4, dpi = 300)

plot_deposition_wind <- deposition_over_time %>%
  ggplot(aes(wind_distance_km, distance_m, colour = factor(size), group = size)) +
  geom_line() +
  labs(
    x = "Horizontal travel distance at 5 m/s wind (km)",
    y = "Settling distance (m)",
    colour = "Particle size"
  )

plot_deposition_wind

ggsave(here(fig_dir, "figure_dry_deposition_with_wind.png"), plot = plot_deposition_wind, width = 7, height = 4, dpi = 300)
```

## 14) Session information

Session information is saved at the end so software versions are documented with the analytical output.

```{r session-info}
sessionInfo()
```
