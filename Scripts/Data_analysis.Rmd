---
title: "Airborne eDNA Size-Fraction Analysis"
output: html_notebook
---

- Purpose: report the full size-fraction airborne eDNA analysis used for the manuscript.
- Input level: processed sequencing and metadata tables already prepared upstream.
- Output level: manuscript-ready QC summaries, intermediate tables, statistical results, and figures.
- Analytical order:
  - sequencing depth and controls,
  - contaminant assessment and filtering,
  - richness and composition patterns across size fractions and seasons,
  - integration with Biotrack optical measurements,
  - weather and deposition context.

## 1) Analysis setup

- Load analysis packages.
- Set default plotting theme.
- Create output directories for figures and derived tables.

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(readxl)
library(lubridate)
library(vegan)
library(iNEXT)
library(fuzzyjoin)
library(zoo)
library(broom)
library(car)
library(suncalc)

theme_set(theme_bw(base_size = 11))

fig_dir <- here("Figures", "data_analysis_clean")
derived_dir <- here("Data", "derived")

dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(derived_dir, recursive = TRUE, showWarnings = FALSE)
```

## 2) Load manuscript input data

- Read processed ASV abundance and taxonomy tables.
- Read sample metadata and DNA concentration measurements.
- Read Biotrack campaign files.
- Read meteorological and deposition inputs.

```{r load-data}
asv_table_raw <- read_tsv(here("Data", "COI_ASW_glom.txt"), show_col_types = FALSE)
taxonomy_table_raw <- read_tsv(here("Data", "COI_taxa_80_glom.txt"), show_col_types = FALSE)
taxonomy_probabilities <- read_tsv(here("Data", "COI_Sintax_prob.txt"), show_col_types = FALSE)
sample_metadata_raw <- read_tsv(here("Data", "sample_meta.tsv"), show_col_types = FALSE)
dna_concentration <- read_tsv(here("Data", "DNA_concentration_HS.txt"), show_col_types = FALSE)

biotrack_20201006 <- read_excel(here("Data", "Hyltemossa_20201006.xlsx"))
biotrack_20201022 <- read_excel(here("Data", "Hyltemossa_20201022.xlsx"))
biotrack_20210428 <- read_excel(here("Data", "Hyltemossa_20210428.xlsx"))
biotrack_20210524 <- read_excel(here("Data", "Hyltemossa_20210524.xlsx"))

weather_30m_raw <- read_delim(
  here("Data", "ICOS", "My data cart", "ICOS_ATC_NRT_HTM_2021-02-01_2022-02-28_30.0_612.MTO"),
  delim = ";",
  skip = 38,
  show_col_types = FALSE
)

precip_raw <- read_delim(
  here("Data", "ICOS", "SE-Htm_meteo_2020_CP_flag.txt"),
  delim = ",",
  show_col_types = FALSE
)

deposition_raw <- read_tsv(here("Data", "deposition_speed.txt"), show_col_types = FALSE)

tibble(
  table = c(
    "asv_table_raw", "taxonomy_table_raw", "taxonomy_probabilities",
    "sample_metadata_raw", "dna_concentration", "weather_30m_raw"
  ),
  rows = c(
    nrow(asv_table_raw), nrow(taxonomy_table_raw), nrow(taxonomy_probabilities),
    nrow(sample_metadata_raw), nrow(dna_concentration), nrow(weather_30m_raw)
  ),
  cols = c(
    ncol(asv_table_raw), ncol(taxonomy_table_raw), ncol(taxonomy_probabilities),
    ncol(sample_metadata_raw), ncol(dna_concentration), ncol(weather_30m_raw)
  )
)
```

## 3) Prepare sample metadata for ecological comparisons

- Harmonize sample metadata into one analysis table.
- Parse timestamps and derive season.
- Map NGI stage labels to aerodynamic diameter classes.
- Keep only samples present in the ASV table.

```{r metadata-prep}
sample_metadata <- sample_metadata_raw %>%
  rename(Sample = Sample_ID) %>%
  mutate(
    Start_Date = ymd_hms(Start_Date, truncated = 3),
    End_Date = ymd_hms(End_Date, truncated = 3),
    season = case_when(
      Start_Date < ymd("2020-11-01") ~ "Fall",
      TRUE ~ "Spring"
    ),
    Time_h = as.numeric(Time_h),
    Time_h = case_when(
      is.na(Time_h) ~ as.numeric(difftime(End_Date, Start_Date, units = "hours")),
      TRUE ~ Time_h
    ),
    Type = case_when(
      is.na(Blank) ~ Type,
      TRUE ~ Blank
    ),
    SizeFrac = as.character(SizeFrac),
    SizeFrac = dplyr::recode(
      SizeFrac,
      "1" = "8.83",
      "2" = "4.89",
      "3" = "3.09",
      "4" = "1.82",
      "5" = "1.03",
      "6" = "0.60",
      "7" = "0.37",
      "8" = "< 0.37"
    ),
    SizeFrac = factor(SizeFrac, levels = c("< 0.37", "0.37", "0.60", "1.03", "1.82", "3.09", "4.89", "8.83"))
  ) %>%
  filter(Sample %in% asv_table_raw$Sample)

sample_metadata %>%
  write_tsv(here(derived_dir, "sample_metadata_prepared.tsv"))

sample_metadata %>%
  count(Type, season, SizeFrac, sort = TRUE)
```

## 4) Read-depth quality assessment and manuscript reporting statistics

- Summarize total reads and detected sequence counts per sample.
- Compare positive samples and negative controls.
- Flag low-read positive samples and high-read controls using fixed thresholds.
- Save method-ready summary statistics and flagged sample lists.

```{r read-summary}
control_samples <- c("Extr_Bl", "S55", "S64", "S81")
low_positive_threshold <- 5000
high_control_threshold <- 5000

sample_read_summary <- asv_table_raw %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  summarise(
    total_reads = sum(reads),
    n_detected_seq = sum(reads > 0),
    .groups = "drop"
  ) %>%
  left_join(sample_metadata, by = "Sample") %>%
  left_join(dna_concentration, by = "Sample") %>%
  mutate(
    sample_class = case_when(
      Sample %in% control_samples ~ "Negative control",
      Type == "Blank" ~ "Negative control",
      TRUE ~ "Positive sample"
    )
  )

sample_read_summary %>%
  write_tsv(here(derived_dir, "sample_read_summary.tsv"))

read_depth_stats <- sample_read_summary %>%
  group_by(sample_class) %>%
  summarise(
    n_samples = n(),
    mean_reads = mean(total_reads),
    median_reads = median(total_reads),
    min_reads = min(total_reads),
    max_reads = max(total_reads),
    .groups = "drop"
  )

read_depth_flags <- sample_read_summary %>%
  mutate(
    qc_flag = case_when(
      sample_class == "Positive sample" & total_reads < low_positive_threshold ~ "Low-read positive",
      sample_class == "Negative control" & total_reads >= high_control_threshold ~ "High-read control",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(qc_flag)) %>%
  select(Sample, sample_class, Type, season, total_reads, n_detected_seq, qc_flag)

method_read_stats <- sample_read_summary %>%
  summarise(
    n_positive_samples = sum(sample_class == "Positive sample"),
    n_negative_controls = sum(sample_class == "Negative control"),
    mean_reads_positive = mean(total_reads[sample_class == "Positive sample"]),
    median_reads_positive = median(total_reads[sample_class == "Positive sample"]),
    mean_reads_controls = mean(total_reads[sample_class == "Negative control"]),
    median_reads_controls = median(total_reads[sample_class == "Negative control"]),
    n_low_read_positive = sum(sample_class == "Positive sample" & total_reads < low_positive_threshold),
    n_high_read_controls = sum(sample_class == "Negative control" & total_reads >= high_control_threshold)
  ) %>%
  pivot_longer(cols = everything(), names_to = "metric", values_to = "value")

method_read_stats_wide <- method_read_stats %>%
  pivot_wider(names_from = metric, values_from = value)

read_depth_stats %>%
  write_tsv(here(derived_dir, "read_depth_summary_by_class.tsv"))
read_depth_flags %>%
  write_tsv(here(derived_dir, "read_depth_qc_flags.tsv"))
method_read_stats %>%
  write_tsv(here(derived_dir, "method_read_depth_stats.tsv"))

read_depth_stats
```

- Positive samples: `r method_read_stats_wide$n_positive_samples`
- Negative controls: `r method_read_stats_wide$n_negative_controls`
- Mean reads in positive samples: `r round(method_read_stats_wide$mean_reads_positive)`
- Median reads in positive samples: `r round(method_read_stats_wide$median_reads_positive)`
- Mean reads in controls: `r round(method_read_stats_wide$mean_reads_controls)`
- Median reads in controls: `r round(method_read_stats_wide$median_reads_controls)`
- Low-read positive samples (`r low_positive_threshold` reads cutoff): `r method_read_stats_wide$n_low_read_positive`
- High-read controls (`r high_control_threshold` reads cutoff): `r method_read_stats_wide$n_high_read_controls`
- Plot below: read-depth rank distribution by sample class.

```{r read-depth-rank-plot}
plot_reads_rank <- sample_read_summary %>%
  arrange(desc(total_reads)) %>%
  mutate(rank = row_number()) %>%
  ggplot(aes(rank, total_reads, colour = sample_class)) +
  geom_point() +
  scale_y_log10() +
  geom_hline(yintercept = c(low_positive_threshold, high_control_threshold), linetype = "dashed") +
  facet_wrap(~sample_class, scales = "free_x") +
  scale_color_manual(values = c("Positive sample" = "#025196", "Negative control" = "#D1495B")) +
  labs(x = "Sample rank by read count", y = "Total reads", colour = NULL)

plot_reads_rank

ggsave(
  filename = here(fig_dir, "qc_reads_by_sample_rank.png"),
  plot = plot_reads_rank,
  width = 7,
  height = 4,
  dpi = 300
)
```

- Plot below: relationship between DNA concentration and sequencing depth for positive samples.
- Objective: assess whether sample-yield variation could influence downstream richness comparisons.

```{r dna-vs-reads}
plot_dna_reads <- sample_read_summary %>%
  filter(sample_class == "Positive sample") %>%
  filter(!is.na(DNA_C)) %>%
  ggplot(aes(DNA_C, total_reads + 1, colour = season)) +
  geom_point() +
  facet_wrap(~Type) +
  scale_y_log10() +
  geom_hline(yintercept = 2e4, linetype = "dashed") +
  labs(x = "DNA concentration", y = "Reads")

plot_dna_reads

ggsave(
  filename = here(fig_dir, "qc_dna_vs_reads.png"),
  plot = plot_dna_reads,
  width = 7,
  height = 4,
  dpi = 300
)
```

## 5) Contaminant assessment and removal

- Candidate contaminants include:
  - sequences detected in extraction blank,
  - sequences detected in process blanks,
  - sequences assigned to human.
- The union is removed from all samples.
- Outputs include:
  - contaminant catalog with taxonomy,
  - per-sample occurrence and read totals for each contaminant sequence,
  - control accounting before and after filtering.

```{r contaminant-checks}
extraction_blank_sequences <- asv_table_raw %>%
  filter(Sample == "Extr_Bl") %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  pull(seq)

human_sequences <- taxonomy_table_raw %>%
  filter(genus == "Homo") %>%
  pull(seq)

process_blank_sequences <- asv_table_raw %>%
  filter(Sample %in% control_samples[control_samples != "Extr_Bl"]) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  pull(seq)

sequences_to_remove <- unique(c(extraction_blank_sequences, human_sequences, process_blank_sequences))

contaminant_catalog <- bind_rows(
  tibble(seq = extraction_blank_sequences, source = "Extraction blank"),
  tibble(seq = process_blank_sequences, source = "Process blanks"),
  tibble(seq = human_sequences, source = "Human assignment")
) %>%
  distinct()

contaminant_catalog_taxonomy <- contaminant_catalog %>%
  group_by(seq) %>%
  summarise(contaminant_source = str_c(sort(unique(source)), collapse = "; "), .groups = "drop") %>%
  left_join(taxonomy_table_raw, by = "seq")

control_contaminant_accounting <- asv_table_raw %>%
  filter(Sample %in% control_samples) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  mutate(
    contaminant_flag = case_when(
      seq %in% sequences_to_remove ~ "candidate_contaminant",
      TRUE ~ "not_flagged"
    ),
    contaminant_flag = factor(contaminant_flag, levels = c("candidate_contaminant", "not_flagged"))
  ) %>%
  group_by(Sample, contaminant_flag) %>%
  summarise(
    reads = sum(reads),
    n_seq = n(),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = contaminant_flag,
    values_from = c(reads, n_seq),
    values_fill = 0,
    names_expand = TRUE
  ) %>%
  mutate(
    prop_reads_candidate_contaminant = reads_candidate_contaminant / pmax(reads_candidate_contaminant + reads_not_flagged, 1)
  )

contaminant_details <- asv_table_raw %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(seq %in% sequences_to_remove, reads > 0) %>%
  left_join(contaminant_catalog_taxonomy, by = "seq") %>%
  group_by(seq, contaminant_source, kingdom, phylum, class, order, family, genus, species) %>%
  summarise(
    n_samples_detected = n_distinct(Sample),
    n_control_samples_detected = n_distinct(Sample[Sample %in% control_samples]),
    total_reads_all_samples = sum(reads),
    total_reads_controls = sum(reads[Sample %in% control_samples]),
    sample_list = str_c(sort(unique(Sample)), collapse = "; "),
    .groups = "drop"
  ) %>%
  arrange(desc(total_reads_all_samples))

contaminant_catalog_taxonomy %>%
  write_tsv(here(derived_dir, "contaminant_catalog.tsv"))
control_contaminant_accounting %>%
  write_tsv(here(derived_dir, "control_contaminant_accounting_before_filter.tsv"))
contaminant_details %>%
  write_tsv(here(derived_dir, "contaminant_sequence_details.tsv"))

contaminant_catalog_taxonomy %>%
  count(contaminant_source, name = "n_sequences")
```

```{r contaminant-details-table}
contaminant_details
```

```{r control-contaminant-accounting}
control_contaminant_accounting
```

```{r remove-contaminants}
asv_table_clean <- asv_table_raw %>%
  select(-any_of(sequences_to_remove))

taxonomy_table_clean <- taxonomy_table_raw %>%
  filter(seq %in% colnames(asv_table_clean))

tibble(seq_removed = sequences_to_remove) %>%
  write_tsv(here(derived_dir, "removed_sequences.tsv"))
asv_table_clean %>%
  write_tsv(here(derived_dir, "asv_table_clean.tsv"))
taxonomy_table_clean %>%
  write_tsv(here(derived_dir, "taxonomy_table_clean.tsv"))

control_after_filter <- asv_table_clean %>%
  filter(Sample %in% control_samples) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  summarise(
    reads_remaining = sum(reads),
    n_seq_remaining = sum(reads > 0),
    .groups = "drop"
  )

control_after_filter %>%
  write_tsv(here(derived_dir, "control_signal_after_filter.tsv"))

contaminant_removal_summary <- tibble(
  metric = c("raw_sequences", "removed_sequences", "clean_sequences"),
  n = c(ncol(asv_table_raw) - 1, length(sequences_to_remove), ncol(asv_table_clean) - 1)
)

contaminant_removal_summary
```

```{r control-summary-stats}
control_after_summary <- control_after_filter %>%
  summarise(
    n_controls = n(),
    n_controls_with_residual_reads = sum(reads_remaining > 0),
    max_residual_reads = max(reads_remaining),
    median_residual_reads = median(reads_remaining)
  )

control_before_summary <- control_contaminant_accounting %>%
  summarise(
    mean_prop_candidate_contaminant = mean(prop_reads_candidate_contaminant),
    min_prop_candidate_contaminant = min(prop_reads_candidate_contaminant),
    max_prop_candidate_contaminant = max(prop_reads_candidate_contaminant)
  )

tibble(
  metric = c(
    "mean_prop_candidate_contaminant_before_filter",
    "min_prop_candidate_contaminant_before_filter",
    "max_prop_candidate_contaminant_before_filter",
    "controls_with_residual_reads_after_filter",
    "total_controls",
    "median_residual_reads_after_filter",
    "max_residual_reads_after_filter"
  ),
  value = c(
    control_before_summary$mean_prop_candidate_contaminant,
    control_before_summary$min_prop_candidate_contaminant,
    control_before_summary$max_prop_candidate_contaminant,
    control_after_summary$n_controls_with_residual_reads,
    control_after_summary$n_controls,
    control_after_summary$median_residual_reads,
    control_after_summary$max_residual_reads
  )
)
```

```{r control-after-filter}
control_after_filter
```

- Mean proportion of control reads flagged as candidate contaminants before filtering:
  `r round(control_before_summary$mean_prop_candidate_contaminant, 3)`
- Range across controls: `r round(control_before_summary$min_prop_candidate_contaminant, 3)` to `r round(control_before_summary$max_prop_candidate_contaminant, 3)`
- Controls with residual reads after filtering:
  `r control_after_summary$n_controls_with_residual_reads` of `r control_after_summary$n_controls`
- Median residual reads in controls after filtering: `r round(control_after_summary$median_residual_reads)`
- Maximum residual reads in controls after filtering: `r round(control_after_summary$max_residual_reads)`

## 6) Taxonomic composition across NGI size fractions

- Summarize NGI taxonomic composition across ranks.
- Focus phylum-level figure on Ascomycota, Basidiomycota, and Arthropoda.
- Report relative OTU composition by size fraction and season.

```{r taxa-distribution}
ngi_taxa_distribution <- asv_table_clean %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI") %>%
  left_join(taxonomy_table_clean, by = "seq") %>%
  pivot_longer(
    cols = c("kingdom", "phylum", "class", "order", "family", "genus", "species"),
    names_to = "rank",
    values_to = "taxa"
  ) %>%
  left_join(
    taxonomy_probabilities %>%
      pivot_longer(-seq, names_to = "rank", values_to = "probability"),
    by = c("seq", "rank")
  ) %>%
  mutate(
    taxa = replace_na(taxa, "not assigned"),
    probability = if_else(taxa == "not assigned", NA_real_, probability)
  ) %>%
  group_by(Sample, rank, taxa, season, probability) %>%
  summarise(n_otu = n(), .groups = "drop")

ngi_taxa_distribution %>%
  write_tsv(here(derived_dir, "ngi_taxa_distribution.tsv"))
```

```{r phylum-plot}
phylum_focus <- c("Ascomycota", "Basidiomycota", "Arthropoda")

ngi_phylum_relative <- ngi_taxa_distribution %>%
  filter(rank == "phylum", taxa %in% phylum_focus) %>%
  left_join(sample_metadata %>% select(Sample, SizeFrac, season), by = c("Sample", "season")) %>%
  group_by(Sample, SizeFrac, season, taxa) %>%
  summarise(n_otu = sum(n_otu), .groups = "drop") %>%
  group_by(SizeFrac, season, taxa) %>%
  summarise(n_otu = mean(n_otu), .groups = "drop") %>%
  group_by(SizeFrac, season) %>%
  mutate(total_otu = sum(n_otu), relative_otu = n_otu / total_otu) %>%
  ungroup()

phylum_label_df <- ngi_phylum_relative %>%
  distinct(SizeFrac, season, total_otu) %>%
  mutate(total_otu = round(total_otu), y = 0.5)

ngi_phylum_relative %>%
  write_tsv(here(derived_dir, "ngi_relative_phylum_abundance.tsv"))

plot_phylum <- ngi_phylum_relative %>%
  ggplot(aes(SizeFrac, relative_otu, fill = taxa)) +
  geom_col() +
  geom_text(
    data = phylum_label_df,
    aes(x= SizeFrac, y = y, label = total_otu),
    colour = "white",
    inherit.aes = FALSE
  ) +
  facet_grid(~season) +
  scale_fill_manual(values = c("#081A5A", "#E74137", "#DAA520")) +
  labs(
    x = "Aerodynamic diameter D50 (um)",
    y = "Relative abundance of OTUs",
    fill = NULL
  ) +
  theme(legend.position = "bottom")

plot_phylum

ggsave(here(fig_dir, "figure_relative_phylum_abundance.png"), plot = plot_phylum, width = 8, height = 4, dpi = 300)
ggsave(here(fig_dir, "figure_relative_phylum_abundance.pdf"), plot = plot_phylum, width = 8, height = 4)
```

## 7) Rarefaction and coverage-based richness estimates

- Generate rarefaction curves for major phyla.
- Precompute NGI phylum-specific matrices once and reuse them across analyses.
- Compute coverage-standardized richness with `estimateD` (iNEXT package) for faster runtime.
- Use standardized richness values for between-season and between-size comparisons.

```{r rarefaction}
main_phyla <- c("Arthropoda", "Ascomycota", "Basidiomycota", "Chordata")

asv_matrix_clean <- asv_table_clean %>%
  column_to_rownames("Sample") %>%
  as.matrix()

asv_matrix_clean <- asv_matrix_clean[rowSums(asv_matrix_clean) > 0, , drop = FALSE]
ngi_samples <- sample_metadata %>%
  filter(Type == "NGI") %>%
  pull(Sample) %>%
  intersect(rownames(asv_matrix_clean))

asv_matrix_ngi <- asv_matrix_clean[ngi_samples, , drop = FALSE]

phylum_matrix_tbl <- tibble(phylum = main_phyla) %>%
  mutate(
    seq_ids = map(phylum, ~ taxonomy_table_clean %>%
      filter(phylum == .x) %>%
      pull(seq)),
    matrix = map(seq_ids, ~ {
      phylum_matrix <- asv_matrix_ngi[, intersect(.x, colnames(asv_matrix_ngi)), drop = FALSE]
      phylum_matrix <- phylum_matrix[rowSums(phylum_matrix) > 0, , drop = FALSE]
      phylum_matrix
    })
  ) %>%
  filter(map_int(matrix, nrow) > 0, map_int(matrix, ncol) > 0)

phylum_matrix_sizes <- phylum_matrix_tbl %>%
  transmute(
    phylum,
    n_samples = map_int(matrix, nrow),
    n_sequences = map_int(matrix, ncol)
  )

phylum_matrix_sizes %>%
  write_tsv(here(derived_dir, "phylum_matrix_sizes.tsv"))

rarefaction_list <- list()

for (i in seq_len(nrow(phylum_matrix_tbl))) {
  phylum_name <- phylum_matrix_tbl$phylum[[i]]
  phylum_matrix <- phylum_matrix_tbl$matrix[[i]]
  rare_df <- rarecurve(phylum_matrix, step = 200, tidy = TRUE)
  rare_df$Phylum <- phylum_name
  rarefaction_list[[phylum_name]] <- rare_df
}

rarefaction_df <- bind_rows(rarefaction_list) %>%
  rename(size = Sample, Sample = Site)

rarefaction_df %>%
  write_tsv(here(derived_dir, "rarefaction_curves.tsv"))

plot_rarefaction <- rarefaction_df %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI") %>%
  ggplot(aes(size, Species, group = Sample, colour = season)) +
  geom_line(alpha = 0.6) +
  facet_wrap(~Phylum, scales = "free_y") +
  scale_x_continuous(limits = c(0, 2e4)) +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "Reads", y = "OTUs") +
  theme(legend.position = "bottom")

plot_rarefaction

ggsave(here(fig_dir, "figure_rarefaction_curves.png"), plot = plot_rarefaction, width = 8, height = 5, dpi = 300)
```

```{r diversity-estimates, cache=TRUE}
coverage_target <- 0.99

diversity_estimates <- phylum_matrix_tbl %>%
  mutate(
    estimate = map(
      matrix,
      ~ iNEXT::estimateD(
        t(.x),
        datatype = "abundance",
        base = "coverage",
        level = coverage_target,
        q = 0,
        nboot = 0
      )
    )
  ) %>%
  select(phylum, estimate) %>%
  unnest(estimate) %>%
  rename(Sample = Assemblage)

diversity_estimates %>%
  write_tsv(here(derived_dir, "diversity_estimates_iNEXT.tsv"))

diversity_estimates %>%
  group_by(phylum) %>%
  summarise(
    n_samples = n(),
    median_coverage = median(SC),
    min_coverage = min(SC),
    max_coverage = max(SC),
    .groups = "drop"
  )
```

## 8) Richness trends by size class, season, and DNA concentration

- Plot coverage-standardized richness across size fractions and seasons.
- Evaluate DNA concentration versus richness.
- Fit a linear model to quantify contributions of season, phylum, size fraction, and DNA concentration.

```{r richness-by-size-plot}
diversity_plot_data <- diversity_estimates %>%
  filter(phylum != "Chordata") %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI")

plot_richness_size <- diversity_plot_data %>%
  ggplot(aes(SizeFrac, qD, colour = season)) +
  geom_point(alpha = 0.5, size = 1) +
  geom_line(aes(group = Start_Date), alpha = 0.4, linewidth = 0.3) +
  geom_smooth(aes(group = season), se = FALSE) +
  facet_grid(phylum ~ ., scales = "free") +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "Aerodynamic diameter D50 (um)", y = "OTU richness") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_richness_size

ggsave(here(fig_dir, "figure_richness_by_size_fraction.png"), plot = plot_richness_size, width = 6, height = 7, dpi = 300)
```

```{r dna-vs-richness-plot}
plot_dna_richness <- diversity_plot_data %>%
  left_join(dna_concentration, by = "Sample") %>%
  ggplot(aes(DNA_C, qD, colour = season)) +
  geom_point(alpha = 0.8, size = 0.8) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2, aes(group = interaction(season, SizeFrac))) +
  facet_grid(phylum ~ season, scales = "free_y") +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "DNA concentration", y = "OTU richness")

plot_dna_richness

ggsave(here(fig_dir, "figure_dna_vs_richness.png"), plot = plot_dna_richness, width = 7, height = 6, dpi = 300)
```

```{r diversity-model}
diversity_model <- diversity_plot_data %>%
  left_join(dna_concentration, by = "Sample") %>%
  lm(log(qD) ~ season + phylum + SizeFrac + log10(DNA_C), data = .)

diversity_model_anova <- Anova(diversity_model, type = 2) %>%
  tidy() %>%
  mutate(across(where(is.numeric), ~ signif(.x, 3)))

diversity_model_anova %>%
  write_tsv(here(derived_dir, "diversity_model_anova.tsv"))

diversity_model_anova
```

## 9) Community ordination and dominant sequence patterns

- Visualize compositional structure with Bray-Curtis NMDS.
- Visualize dominant ASV patterns with a heatmap.
- Compare size-fraction and seasonal structure in community composition.

```{r nmds}
asv_ngi_matrix <- asv_table_clean %>%
  filter(str_detect(Sample, "^S")) %>%
  column_to_rownames("Sample") %>%
  as.matrix()

asv_ngi_matrix <- asv_ngi_matrix[rowSums(asv_ngi_matrix) > 0, , drop = FALSE]
asv_ngi_matrix <- asv_ngi_matrix[, colSums(asv_ngi_matrix) > 0, drop = FALSE]

ngi_nmds <- vegan::metaMDS(asv_ngi_matrix, distance = "bray", autotransform = TRUE)

nmds_points <- as_tibble(ngi_nmds$points, rownames = "Sample") %>%
  left_join(sample_metadata, by = "Sample")

nmds_points %>%
  write_tsv(here(derived_dir, "nmds_points.tsv"))

plot_nmds <- nmds_points %>%
  filter(SizeFrac != "< 0.37") %>%
  ggplot(aes(MDS1, MDS2, colour = SizeFrac)) +
  geom_point() +
  facet_wrap(~season)

plot_nmds

ggsave(here(fig_dir, "figure_nmds.png"), plot = plot_nmds, width = 7, height = 4, dpi = 300)
```

```{r heatmap-top-seq}
top_sequences_per_sample <- asv_table_clean %>%
  filter(str_detect(Sample, "^S")) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  arrange(desc(reads), .by_group = TRUE) %>%
  slice_head(n = 50) %>%
  ungroup()

heatmap_df <- asv_table_clean %>%
  filter(Sample %in% unique(top_sequences_per_sample$Sample)) %>%
  select(Sample, any_of(unique(top_sequences_per_sample$seq))) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  left_join(sample_metadata, by = "Sample") %>%
  mutate(
    Sample = fct_reorder(Sample, as.numeric(SizeFrac), .desc = TRUE),
    seq = factor(seq)
  )

heatmap_df %>%
  write_tsv(here(derived_dir, "heatmap_top_sequences.tsv"))

plot_heatmap <- heatmap_df %>%
  ggplot(aes(Sample, seq, fill = log10(reads + 1))) +
  geom_tile() +
  facet_wrap(season ~ SizeFrac, scales = "free_x", ncol = 8) +
  scale_fill_viridis_c(na.value = "white") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

plot_heatmap

ggsave(here(fig_dir, "figure_heatmap_top_sequences.png"), plot = plot_heatmap, width = 12, height = 7, dpi = 300)
```

## 10) Process Biotrack optical measurements

- Merge Biotrack campaign files into one dataset.
- Convert counts to concentrations per liter.
- Keep optical size classes aligned with the sequencing size-fraction framework.

```{r biotrack-prepare}
biotrack_combined <- bind_rows(
  biotrack_20201006 %>% mutate(season = "Fall"),
  biotrack_20201022 %>% mutate(season = "Fall"),
  biotrack_20210428 %>% mutate(season = "Spring"),
  biotrack_20210524 %>% mutate(season = "Spring")
) %>%
  filter(!is.na(Date)) %>%
  select(Date, Time, starts_with("Ch"), FlowStatus, Laser_Status, Vol_L, season) %>%
  pivot_longer(cols = starts_with("Ch"), names_to = "Size_frac", values_to = "count") %>%
  mutate(
    type = case_when(str_detect(Size_frac, "Value") ~ "all", TRUE ~ "bio"),
    Size_frac = str_sub(Size_frac, 1, 3)
  ) %>%
  pivot_wider(names_from = type, values_from = count) %>%
  mutate(
    Date_Time = ymd_hms(paste(Date, str_sub(as.character(Time), 12, 19), sep = "_")),
    Date_Time = round_date(Date_Time, unit = "minute")
  ) %>%
  arrange(Date_Time) %>%
  filter(!Size_frac %in% c("Ch1", "Ch2")) %>%
  mutate(
    Size_frac = dplyr::recode(Size_frac, "Ch3" = "1-3um", "Ch4" = "3-5um", "Ch5" = "5-10um", "Ch6" = "10-14um"),
    bio_per_l = bio / Vol_L,
    Date = floor_date(Date_Time, unit = "day")
  )

biotrack_combined %>%
  write_tsv(here(derived_dir, "biotrack_combined.tsv"))
```

```{r biotrack-day-night}
sun_table <- biotrack_combined %>%
  distinct(Date) %>%
  mutate(lat = 56.0976, lon = 13.4189, date = as.Date(Date)) %>%
  suncalc::getSunlightTimes(data = .) %>%
  transmute(
    Date = date,
    sunrise = hms::as_hms(sunrise),
    sunset = hms::as_hms(sunset)
  )

biotrack_plot_data <- biotrack_combined %>%
  left_join(sun_table, by = "Date") %>%
  mutate(
    HMS = hms::as_hms(Date_Time),
    daytime = case_when(
      HMS < sunrise ~ "night",
      HMS >= sunrise & HMS < sunset ~ "day",
      HMS >= sunset ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  group_by(season, Size_frac) %>%
  mutate(
    bio_h = rollapply(bio_per_l, width = 60, FUN = mean, na.rm = TRUE, fill = NA, partial = TRUE),
    bio_day = rollapply(bio_per_l, width = 720, FUN = mean, na.rm = TRUE, fill = NA, partial = FALSE)
  ) %>%
  ungroup()

biotrack_daynight_blocks <- biotrack_plot_data %>%
  filter(!is.na(daytime)) %>%
  arrange(Date_Time) %>%
  mutate(group = cumsum(daytime != lag(daytime, default = first(daytime)))) %>%
  group_by(group, daytime) %>%
  summarise(start = min(Date_Time), end = max(Date_Time), .groups = "drop") %>%
  filter(end > start)

plot_biotrack_time <- biotrack_plot_data %>%
  ggplot(aes(Date_Time)) +
  geom_rect(
    data = biotrack_daynight_blocks,
    aes(xmin = start, xmax = end, ymin = 0.001, ymax = 500, fill = daytime),
    inherit.aes = FALSE,
    alpha = 0.2
  ) +
  geom_line(aes(y = bio_h, colour = Size_frac), linewidth = 0.6) +
  facet_wrap(~season, scales = "free_x", nrow = 2) +
  scale_y_log10() +
  scale_fill_manual(values = c("day" = "#FDC500", "night" = "#00296B")) +
  labs(y = "Bioaerosol concentration per L", x = NULL, fill = NULL)

plot_biotrack_time

ggsave(here(fig_dir, "figure_biotrack_time_series.png"), plot = plot_biotrack_time, width = 10, height = 5, dpi = 300)
```

## 11) Link NGI filter classes with Biotrack classes

- Match NGI sampling windows to Biotrack timestamps.
- Aggregate Biotrack channels to NGI-comparable size classes.
- Relate optical counts to DNA concentration and richness.

```{r match-ngi-biotrack}
ngi_biotrack <- sample_metadata %>%
  filter(Type == "NGI") %>%
  fuzzy_left_join(
    biotrack_combined,
    by = c("Start_Date" = "Date_Time", "End_Date" = "Date_Time"),
    match_fun = list(`<=`, `>=`)
  ) %>%
  group_by(Sample, Size_frac) %>%
  summarise(bio = sum(bio, na.rm = TRUE), .groups = "drop")

matched_dna_biotrack <- ngi_biotrack %>%
  pivot_wider(names_from = Size_frac, values_from = bio) %>%
  mutate(Ch5_6 = `5-10um` + `10-14um`) %>%
  select(Sample, `1-3um`, `3-5um`, Ch5_6) %>%
  pivot_longer(-Sample, names_to = "BT_Size_frac", values_to = "count") %>%
  left_join(sample_metadata %>% select(Sample, SizeFrac), by = "Sample") %>%
  mutate(
    match = case_when(
      SizeFrac %in% c("8.83", "4.89") & BT_Size_frac == "Ch5_6" ~ TRUE,
      SizeFrac == "3.09" & BT_Size_frac == "3-5um" ~ TRUE,
      SizeFrac %in% c("1.82", "1.03") & BT_Size_frac == "1-3um" ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  filter(match)

matched_dna_biotrack %>%
  write_tsv(here("Data", "Matched_DNA_Biotrack.txt"))
matched_dna_biotrack %>%
  write_tsv(here(derived_dir, "matched_dna_biotrack.tsv"))

matched_dna_biotrack
```

```{r biotrack-vs-dna-plot}
plot_dna_vs_biotrack <- matched_dna_biotrack %>%
  left_join(dna_concentration, by = "Sample") %>%
  left_join(sample_metadata, by = "Sample") %>%
  ggplot(aes(log10(count), DNA_C, colour = SizeFrac)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2) +
  labs(x = "log10(Biotrack count)", y = "DNA concentration") +
  scale_color_brewer(palette = "Set1")

plot_dna_vs_biotrack

ggsave(here(fig_dir, "figure_biotrack_vs_dna.png"), plot = plot_dna_vs_biotrack, width = 6, height = 4, dpi = 300)
```

```{r biotrack-vs-richness-plot}
plot_richness_vs_biotrack <- matched_dna_biotrack %>%
  left_join(diversity_estimates, by = "Sample") %>%
  filter(!is.na(phylum), phylum != "Chordata") %>%
  left_join(sample_metadata, by = "Sample") %>%
  ggplot(aes(count, qD, colour = SizeFrac)) +
  geom_point(alpha = 0.8, size = 0.8) +
  facet_grid(phylum ~ season, scales = "free_y") +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Biotrack count", y = "OTU richness") +
  scale_color_brewer(palette = "Set1")

plot_richness_vs_biotrack

ggsave(here(fig_dir, "figure_biotrack_vs_richness.png"), plot = plot_richness_vs_biotrack, width = 7, height = 6, dpi = 300)
```

## 12) Weather context and wind-direction structure

- Clean meteorological inputs for the study period.
- Summarize wind speed and direction by month.
- Provide airflow context for observed biological patterns.

```{r weather-clean}
weather_30m <- weather_30m_raw %>%
  select(Year, Month, Day, Hour, AT, RH, WS, WD) %>%
  mutate(date = ymd(paste(Year, Month, Day)))

precip_htm <- precip_raw %>%
  select(date, time, P_1_1_1, Swin_1_2_1, Lwin_1_2_1, Sun_1_1_1, RH_1_1_1, Ta_1_1_1) %>%
  setNames(c("date", "time", "precipitation", "radiation_SW", "radiation_LW", "sunshine_frac", "RH", "Temp")) %>%
  slice(-1) %>%
  mutate(across(-c(date, time), as.numeric))

weather_30m %>%
  write_tsv(here(derived_dir, "weather_30m_clean.tsv"))
precip_htm %>%
  write_tsv(here(derived_dir, "precipitation_clean.tsv"))
```

```{r weather-wind-rose}
wind_rose_df <- weather_30m %>%
  filter(WS > 0, WS < 12) %>%
  mutate(
    WS = round(WS),
    WD = cut_interval(WD, 8),
    WD = factor(WD, labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))
  ) %>%
  count(Month, WS, WD, name = "freq")

wind_rose_df %>%
  write_tsv(here(derived_dir, "wind_rose_counts.tsv"))

plot_wind_rose <- wind_rose_df %>%
  ggplot(aes(WD, freq, fill = WS)) +
  geom_col() +
  coord_polar(start = -0.4) +
  scale_fill_viridis_c() +
  facet_wrap(~Month)

plot_wind_rose

ggsave(here(fig_dir, "figure_wind_rose_by_month.png"), plot = plot_wind_rose, width = 8, height = 6, dpi = 300)
```

## 13) Size-dependent dry deposition trajectories

- Compute dry deposition trajectories over 72 hours by size class.
- Quantify vertical settling distance and potential horizontal travel distance.
- Provide physical context for size-fraction biological observations.

```{r deposition-prepare}
colnames(deposition_raw) <- c("size", "speed", "distance")

deposition_over_time <- deposition_raw %>%
  transmute(
    size = as.character(size),
    settling_speed = as.numeric(speed)
  ) %>%
  distinct() %>%
  tidyr::crossing(sec = seq(0, 72 * 3600, 3600)) %>%
  mutate(
    hours = sec / 3600,
    distance_m = pmin(settling_speed * sec / 1e6, 100),
    wind_distance_km = sec * 5 / 1000
  )

deposition_over_time %>%
  write_tsv(here(derived_dir, "deposition_over_time.tsv"))
```

```{r deposition-time-plot}
plot_deposition_time <- deposition_over_time %>%
  ggplot(aes(hours, distance_m, colour = factor(size), group = size)) +
  geom_line() +
  labs(
    x = "Time (hours)",
    y = "Settling distance (m)",
    colour = "Particle size"
  )

plot_deposition_time

ggsave(here(fig_dir, "figure_dry_deposition_over_time.png"), plot = plot_deposition_time, width = 7, height = 4, dpi = 300)
```

```{r deposition-wind-plot}
plot_deposition_wind <- deposition_over_time %>%
  ggplot(aes(wind_distance_km, distance_m, colour = factor(size), group = size)) +
  geom_line() +
  labs(
    x = "Horizontal travel distance at 5 m/s wind (km)",
    y = "Settling distance (m)",
    colour = "Particle size"
  )

plot_deposition_wind

ggsave(here(fig_dir, "figure_dry_deposition_with_wind.png"), plot = plot_deposition_wind, width = 7, height = 4, dpi = 300)
```

## 14) Session information

- Save session information for reproducibility and version tracking.

```{r session-info}
sessionInfo()
```
