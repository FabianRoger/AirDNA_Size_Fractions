---
title: "Airborne eDNA size-fraction analysis"
output: html_notebook
---

This notebook is written as a one-time ecological analysis script with clear, readable steps.

The workflow is:

1. load all required data at the top,
2. prepare metadata and clean the ASV table,
3. run manuscript analyses,
4. write intermediate tables and final figures to file.

## 1) Setup

We load the packages used in this notebook and set a few global options.

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(readxl)
library(lubridate)
library(googlesheets4)
library(vegan)
library(iNEXT)
library(fuzzyjoin)
library(zoo)
library(broom)
library(car)
library(suncalc)

theme_set(theme_bw(base_size = 11))
```

## 2) Paths and output folders

We define all main paths once, then reuse them.

```{r paths}
data_dir <- here("Data")
fig_dir <- here("Figures", "data_analysis_clean")
derived_dir <- here("Data", "derived")

dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)
dir.create(derived_dir, recursive = TRUE, showWarnings = FALSE)

path_asv <- here("Data", "COI_ASW_glom.txt")
path_tax <- here("Data", "COI_taxa_80_glom.txt")
path_prob <- here("Data", "COI_Sintax_prob.txt")
path_dna <- here("Data", "DNA_concentration_HS.txt")
path_diversity_output <- here("Data", "derived", "diversity_estimates_iNEXT.tsv")
path_matched <- here("Data", "Matched_DNA_Biotrack.txt")
path_sample_meta_local <- here("Data", "sample_meta.tsv")

path_biotrack_fall_1 <- here("Data", "Hyltemossa_20201006.xlsx")
path_biotrack_fall_2 <- here("Data", "Hyltemossa_20201022.xlsx")
path_biotrack_spring_1 <- here("Data", "Hyltemossa_20210428.xlsx")
path_biotrack_spring_2 <- here("Data", "Hyltemossa_20210524.xlsx")

path_weather_30m <- here("Data", "ICOS", "My data cart", "ICOS_ATC_NRT_HTM_2021-02-01_2022-02-28_30.0_612.MTO")
path_precip <- here("Data", "ICOS", "SE-Htm_meteo_2020_CP_flag.txt")
path_deposition <- here("Data", "deposition_speed.txt")

required_input_files <- c(
  path_asv, path_tax, path_prob, path_dna,
  path_biotrack_fall_1, path_biotrack_fall_2,
  path_biotrack_spring_1, path_biotrack_spring_2,
  path_weather_30m, path_precip, path_deposition
)

missing_input_files <- required_input_files[!file.exists(required_input_files)]
if (length(missing_input_files) > 0) {
  stop(
    "Missing required input files:\n",
    paste(missing_input_files, collapse = "\n")
  )
}
```

## 3) Load all raw data

All raw inputs are read in this section so data dependencies are explicit.

```{r load-data, message=TRUE}
# Core metabarcoding tables
asv_table_raw <- read_tsv(path_asv, show_col_types = FALSE)
taxonomy_table_raw <- read_tsv(path_tax, show_col_types = FALSE)
taxonomy_probabilities <- read_tsv(path_prob, show_col_types = FALSE)
dna_concentration <- read_tsv(path_dna, show_col_types = FALSE)

# Metadata: local file by default, optional refresh from Google Sheet
sample_meta_url <- "https://docs.google.com/spreadsheets/d/1AMpJDHXKzxpfitL9JML8e-8vKTjnSNZT2oq84qmRmuM/edit?usp=sharing"
refresh_sample_meta <- tolower(Sys.getenv("REFRESH_SAMPLE_META", "false")) == "true"

if (refresh_sample_meta || !file.exists(path_sample_meta_local)) {
  gs4_deauth()
  sample_meta_raw <- read_sheet(sample_meta_url, col_types = "c")
  write_tsv(sample_meta_raw, path_sample_meta_local)
} else {
  sample_meta_raw <- read_tsv(path_sample_meta_local, show_col_types = FALSE)
}

# Biotrack campaign files
biotrack_fall_1_raw <- read_excel(path_biotrack_fall_1)
biotrack_fall_2_raw <- read_excel(path_biotrack_fall_2)
biotrack_spring_1_raw <- read_excel(path_biotrack_spring_1)
biotrack_spring_2_raw <- read_excel(path_biotrack_spring_2)

# Weather and deposition inputs
weather_30m_raw <- read_delim(path_weather_30m, delim = ";", skip = 38, show_col_types = FALSE)
precip_raw <- read_delim(path_precip, delim = ",", show_col_types = FALSE)
deposition_raw <- read_tsv(path_deposition, show_col_types = FALSE)

# Optional precomputed table
matched_dna_biotrack_existing <- if (file.exists(path_matched)) {
  read_tsv(path_matched, show_col_types = FALSE)
} else {
  NULL
}

tibble(
  object = c("asv_table_raw", "taxonomy_table_raw", "taxonomy_probabilities", "sample_meta_raw", "dna_concentration"),
  rows = c(nrow(asv_table_raw), nrow(taxonomy_table_raw), nrow(taxonomy_probabilities), nrow(sample_meta_raw), nrow(dna_concentration)),
  cols = c(ncol(asv_table_raw), ncol(taxonomy_table_raw), ncol(taxonomy_probabilities), ncol(sample_meta_raw), ncol(dna_concentration))
)
```

## 4) Prepare sample metadata

We standardize metadata columns, parse dates, define season, and map size-fraction labels.

```{r prepare-metadata}
required_meta_cols <- c(
  "Sample_ID", "Type", "Start_Date", "End_Date", "Time_h",
  "SizeFrac", "Blank", "Location", "Description"
)

if (!"Sample_ID" %in% names(sample_meta_raw) && "Sample" %in% names(sample_meta_raw)) {
  sample_meta_raw <- sample_meta_raw %>% rename(Sample_ID = Sample)
}

missing_cols <- setdiff(required_meta_cols, names(sample_meta_raw))
if (length(missing_cols) > 0) {
  for (nm in missing_cols) sample_meta_raw[[nm]] <- NA_character_
}

sample_metadata <- sample_meta_raw %>%
  select(all_of(required_meta_cols)) %>%
  rename(Sample = Sample_ID) %>%
  mutate(
    Start_Date = ymd_hms(Start_Date, truncated = 3),
    End_Date = ymd_hms(End_Date, truncated = 3),
    season = case_when(
      Start_Date < ymd("2020-11-01") ~ "Fall",
      TRUE ~ "Spring"
    ),
    Time_h = as.numeric(Time_h),
    Time_h = case_when(
      is.na(Time_h) & !is.na(Start_Date) & !is.na(End_Date) ~ as.numeric(difftime(End_Date, Start_Date, units = "hours")),
      TRUE ~ Time_h
    ),
    Type = case_when(is.na(Blank) ~ Type, TRUE ~ Blank),
    SizeFrac = as.character(SizeFrac),
    SizeFrac = recode(
      SizeFrac,
      "1" = "8.83",
      "2" = "4.89",
      "3" = "3.09",
      "4" = "1.82",
      "5" = "1.03",
      "6" = "0.60",
      "7" = "0.37",
      "8" = "< 0.37"
    ),
    SizeFrac = factor(SizeFrac, levels = c("< 0.37", "0.37", "0.60", "1.03", "1.82", "3.09", "4.89", "8.83"))
  ) %>%
  filter(Sample %in% asv_table_raw$Sample)

write_tsv(sample_metadata, here(derived_dir, "sample_metadata_prepared.tsv"))

sample_metadata %>%
  count(Type, season, SizeFrac, sort = TRUE)
```

## 5) Initial sample-level checks

These quick checks help confirm sequencing depth and how it relates to DNA concentration.

```{r sample-summary}
sample_read_summary <- asv_table_raw %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  summarise(
    total_reads = sum(reads),
    n_detected_seq = sum(reads > 0),
    .groups = "drop"
  ) %>%
  left_join(sample_metadata, by = "Sample") %>%
  left_join(dna_concentration, by = "Sample")

write_tsv(sample_read_summary, here(derived_dir, "sample_read_summary.tsv"))

sample_read_summary %>%
  arrange(desc(total_reads)) %>%
  mutate(rank = row_number()) %>%
  ggplot(aes(rank, total_reads, colour = Type)) +
  geom_point() +
  scale_y_log10() +
  facet_wrap(~Type)

ggsave(
  filename = here(fig_dir, "qc_reads_by_sample_rank.png"),
  width = 7,
  height = 4,
  dpi = 300
)
```

```{r dna-vs-reads}
sample_read_summary %>%
  filter(!is.na(DNA_C)) %>%
  ggplot(aes(DNA_C, total_reads + 1, colour = season)) +
  geom_point() +
  facet_wrap(~Type) +
  scale_y_log10() +
  geom_hline(yintercept = 2e4, linetype = "dashed") +
  labs(x = "DNA concentration", y = "Reads")

ggsave(
  filename = here(fig_dir, "qc_dna_vs_reads.png"),
  width = 7,
  height = 4,
  dpi = 300
)
```

## 6) Remove contaminants (human and blanks)

We remove sequences identified as human or present in blank controls.

```{r remove-contaminants}
extraction_blank_sequences <- asv_table_raw %>%
  filter(Sample == "Extr_Bl") %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  pull(seq)

human_sequences <- taxonomy_table_raw %>%
  filter(genus == "Homo") %>%
  pull(seq)

process_blank_sequences <- asv_table_raw %>%
  filter(Sample %in% c("S55", "S64", "S81")) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  pull(seq)

sequences_to_remove <- unique(c(extraction_blank_sequences, human_sequences, process_blank_sequences))

asv_table_clean <- asv_table_raw %>%
  select(-any_of(sequences_to_remove))

taxonomy_table_clean <- taxonomy_table_raw %>%
  filter(seq %in% colnames(asv_table_clean))

write_tsv(tibble(seq_removed = sequences_to_remove), here(derived_dir, "removed_sequences.tsv"))
write_tsv(asv_table_clean, here(derived_dir, "asv_table_clean.tsv"))
write_tsv(taxonomy_table_clean, here(derived_dir, "taxonomy_table_clean.tsv"))

tibble(
  metric = c("raw_sequences", "removed_sequences", "clean_sequences"),
  n = c(ncol(asv_table_raw) - 1, length(sequences_to_remove), ncol(asv_table_clean) - 1)
)
```

## 7) Taxonomic composition by size fraction

We summarize OTUs by rank and produce manuscript-style phylum composition plots.

```{r taxa-distribution}
ngi_taxa_distribution <- asv_table_clean %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  filter(reads > 0) %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI") %>%
  left_join(taxonomy_table_clean, by = "seq") %>%
  pivot_longer(
    cols = c("kingdom", "phylum", "class", "order", "family", "genus", "species"),
    names_to = "rank",
    values_to = "taxa"
  ) %>%
  left_join(
    taxonomy_probabilities %>%
      pivot_longer(-seq, names_to = "rank", values_to = "probability"),
    by = c("seq", "rank")
  ) %>%
  mutate(
    taxa = replace_na(taxa, "not assigned"),
    probability = if_else(taxa == "not assigned", NA_real_, probability)
  ) %>%
  group_by(Sample, rank, taxa, season, probability) %>%
  summarise(n_otu = n(), .groups = "drop")

write_tsv(ngi_taxa_distribution, here(derived_dir, "ngi_taxa_distribution.tsv"))
```

```{r phylum-plot}
phylum_focus <- c("Ascomycota", "Basidiomycota", "Arthropoda")

ngi_phylum_relative <- ngi_taxa_distribution %>%
  filter(rank == "phylum", taxa %in% phylum_focus) %>%
  left_join(sample_metadata %>% select(Sample, SizeFrac, season), by = c("Sample", "season")) %>%
  group_by(Sample, SizeFrac, season, taxa) %>%
  summarise(n_otu = sum(n_otu), .groups = "drop") %>%
  group_by(SizeFrac, season, taxa) %>%
  summarise(n_otu = mean(n_otu), .groups = "drop") %>%
  group_by(SizeFrac, season) %>%
  mutate(total_otu = sum(n_otu), relative_otu = n_otu / total_otu) %>%
  ungroup()

phylum_label_df <- ngi_phylum_relative %>%
  distinct(SizeFrac, season, total_otu) %>%
  mutate(total_otu = round(total_otu), y = 0.5)

write_tsv(ngi_phylum_relative, here(derived_dir, "ngi_relative_phylum_abundance.tsv"))

ngi_phylum_relative %>%
  ggplot(aes(SizeFrac, relative_otu, fill = taxa)) +
  geom_col() +
  geom_text(
    data = phylum_label_df,
    aes(y = y, label = total_otu),
    colour = "white",
    inherit.aes = FALSE
  ) +
  facet_grid(~season) +
  scale_fill_manual(values = c("#081A5A", "#E74137", "#DAA520")) +
  labs(
    x = "Aerodynamic diameter D50 (um)",
    y = "Relative abundance of OTUs",
    fill = NULL
  ) +
  theme(legend.position = "bottom")

ggsave(here(fig_dir, "figure_relative_phylum_abundance.png"), width = 8, height = 4, dpi = 300)
ggsave(here(fig_dir, "figure_relative_phylum_abundance.pdf"), width = 8, height = 4)
```

## 8) Rarefaction curves

We compute rarefaction curves for major phyla and save the tidy output.

```{r rarefaction}
main_phyla <- c("Arthropoda", "Ascomycota", "Basidiomycota", "Chordata")

asv_matrix_clean <- asv_table_clean %>%
  column_to_rownames("Sample") %>%
  as.matrix()

asv_matrix_clean <- asv_matrix_clean[rowSums(asv_matrix_clean) > 0, , drop = FALSE]

rarefaction_list <- list()

for (phylum_name in main_phyla) {
  seq_ids <- taxonomy_table_clean %>%
    filter(phylum == phylum_name) %>%
    pull(seq)

  phylum_matrix <- asv_matrix_clean[, intersect(seq_ids, colnames(asv_matrix_clean)), drop = FALSE]
  phylum_matrix <- phylum_matrix[rowSums(phylum_matrix) > 0, , drop = FALSE]

  if (ncol(phylum_matrix) == 0 || nrow(phylum_matrix) == 0) next

  rare_df <- rarecurve(phylum_matrix, step = 200, tidy = TRUE)
  rare_df$Phylum <- phylum_name
  rarefaction_list[[phylum_name]] <- rare_df
}

rarefaction_df <- bind_rows(rarefaction_list) %>%
  rename(size = Sample, Sample = Site)

write_tsv(rarefaction_df, here(derived_dir, "rarefaction_curves.tsv"))

rarefaction_df %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI") %>%
  ggplot(aes(size, Species, group = Sample, colour = season)) +
  geom_line(alpha = 0.6) +
  facet_wrap(~Phylum, scales = "free_y") +
  scale_x_continuous(limits = c(0, 2e4)) +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "Reads", y = "OTUs") +
  theme(legend.position = "bottom")

ggsave(here(fig_dir, "figure_rarefaction_curves.png"), width = 8, height = 5, dpi = 300)
```

## 9) Coverage-based richness estimates (iNEXT)

This is one of the slower steps, so this chunk is cached.

```{r diversity-estimates, cache=TRUE}
diversity_estimate_list <- list()

for (phylum_name in main_phyla) {
  seq_ids <- taxonomy_table_clean %>%
    filter(phylum == phylum_name) %>%
    pull(seq)

  phylum_matrix <- asv_matrix_clean[, intersect(seq_ids, colnames(asv_matrix_clean)), drop = FALSE]
  phylum_matrix <- phylum_matrix[rowSums(phylum_matrix) > 0, , drop = FALSE]

  if (ncol(phylum_matrix) == 0 || nrow(phylum_matrix) == 0) next

  inext_out <- iNEXT::iNEXT(t(phylum_matrix), datatype = "abundance", q = 0, nboot = 10)

  inext_df <- inext_out$iNextEst$coverage_based %>%
    rename(Sample = Assemblage) %>%
    group_by(Sample) %>%
    filter(SC == 1) %>%
    filter(m == max(m)) %>%
    slice(1) %>%
    ungroup() %>%
    mutate(phylum = phylum_name)

  diversity_estimate_list[[phylum_name]] <- inext_df
}

diversity_estimates <- bind_rows(diversity_estimate_list)

write_tsv(diversity_estimates, path_diversity_output)
```

We use the diversity table from the previous chunk for plotting and model summaries.

```{r diversity-plots}
diversity_plot_data <- diversity_estimates %>%
  filter(phylum != "Chordata") %>%
  left_join(sample_metadata, by = "Sample") %>%
  filter(Type == "NGI")

diversity_plot <- diversity_plot_data %>%
  ggplot(aes(SizeFrac, qD, colour = season)) +
  geom_point(alpha = 0.5, size = 1) +
  geom_line(aes(group = Start_Date), alpha = 0.4, linewidth = 0.3) +
  geom_smooth(aes(group = season), se = FALSE) +
  facet_grid(phylum ~ ., scales = "free") +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "Aerodynamic diameter D50 (um)", y = "OTU richness") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

diversity_plot

ggsave(here(fig_dir, "figure_richness_by_size_fraction.png"), diversity_plot, width = 6, height = 7, dpi = 300)

dna_vs_diversity_plot <- diversity_plot_data %>%
  left_join(dna_concentration, by = "Sample") %>%
  ggplot(aes(DNA_C, qD, colour = season)) +
  geom_point(alpha = 0.8, size = 0.8) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2, aes(group = interaction(season, SizeFrac))) +
  facet_grid(phylum ~ season, scales = "free_y") +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_manual(values = c("#025196", "#FDB338")) +
  labs(x = "DNA concentration", y = "OTU richness")

dna_vs_diversity_plot

ggsave(here(fig_dir, "figure_dna_vs_richness.png"), dna_vs_diversity_plot, width = 7, height = 6, dpi = 300)
```

```{r diversity-model}
diversity_model <- diversity_plot_data %>%
  left_join(dna_concentration, by = "Sample") %>%
  lm(log(qD) ~ season + phylum + SizeFrac + log10(DNA_C), data = .)

diversity_model_anova <- Anova(diversity_model, type = 2) %>%
  tidy() %>%
  mutate(across(where(is.numeric), ~ signif(.x, 3)))

write_tsv(diversity_model_anova, here(derived_dir, "diversity_model_anova.tsv"))

diversity_model_anova
```

## 10) NMDS and a simple sequence heatmap

We visualize broad community composition and dominant sequence patterns.

```{r nmds}
asv_ngi_matrix <- asv_table_clean %>%
  filter(str_detect(Sample, "^S")) %>%
  column_to_rownames("Sample") %>%
  as.matrix()

asv_ngi_matrix <- asv_ngi_matrix[rowSums(asv_ngi_matrix) > 0, , drop = FALSE]
asv_ngi_matrix <- asv_ngi_matrix[, colSums(asv_ngi_matrix) > 0, drop = FALSE]

ngi_nmds <- vegan::metaMDS(asv_ngi_matrix, distance = "bray", autotransform = TRUE)

nmds_points <- as_tibble(ngi_nmds$points, rownames = "Sample") %>%
  left_join(sample_metadata, by = "Sample")

write_tsv(nmds_points, here(derived_dir, "nmds_points.tsv"))

nmds_plot <- nmds_points %>%
  filter(SizeFrac != "< 0.37") %>%
  ggplot(aes(MDS1, MDS2, colour = SizeFrac)) +
  geom_point() +
  facet_wrap(~season)

nmds_plot

ggsave(here(fig_dir, "figure_nmds.png"), nmds_plot, width = 7, height = 4, dpi = 300)
```

```{r heatmap-top-seq}
top_sequences_per_sample <- asv_table_clean %>%
  filter(str_detect(Sample, "^S")) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  group_by(Sample) %>%
  arrange(desc(reads), .by_group = TRUE) %>%
  slice_head(n = 50) %>%
  ungroup()

heatmap_df <- asv_table_clean %>%
  filter(Sample %in% unique(top_sequences_per_sample$Sample)) %>%
  select(Sample, any_of(unique(top_sequences_per_sample$seq))) %>%
  pivot_longer(-Sample, names_to = "seq", values_to = "reads") %>%
  left_join(sample_metadata, by = "Sample") %>%
  mutate(
    Sample = fct_reorder(Sample, as.numeric(SizeFrac), .desc = TRUE),
    seq = factor(seq)
  )

write_tsv(heatmap_df, here(derived_dir, "heatmap_top_sequences.tsv"))

heatmap_plot <- heatmap_df %>%
  ggplot(aes(Sample, seq, fill = log10(reads + 1))) +
  geom_tile() +
  facet_wrap(season ~ SizeFrac, scales = "free_x", ncol = 8) +
  scale_fill_viridis_c(na.value = "white") +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

heatmap_plot

ggsave(here(fig_dir, "figure_heatmap_top_sequences.png"), heatmap_plot, width = 12, height = 7, dpi = 300)
```

## 11) Prepare Biotrack time series

We load and combine the four campaign files into one consistent table.

```{r biotrack-prepare}
biotrack_fall_raw <- bind_rows(biotrack_fall_1_raw, biotrack_fall_2_raw)
biotrack_spring_raw <- bind_rows(biotrack_spring_1_raw, biotrack_spring_2_raw)

biotrack_combined <- bind_rows(
  biotrack_fall_raw %>% mutate(season = "Fall"),
  biotrack_spring_raw %>% mutate(season = "Spring")
) %>%
  filter(!is.na(Date)) %>%
  select(Date, Time, starts_with("Ch"), FlowStatus, Laser_Status, Vol_L, season) %>%
  pivot_longer(cols = starts_with("Ch"), names_to = "Size_frac", values_to = "count") %>%
  mutate(
    type = case_when(str_detect(Size_frac, "Value") ~ "all", TRUE ~ "bio"),
    Size_frac = str_sub(Size_frac, 1, 3)
  ) %>%
  pivot_wider(names_from = type, values_from = count) %>%
  mutate(
    Date_Time = ymd_hms(paste(Date, str_sub(as.character(Time), 12, 19), sep = "_")),
    Date_Time = round_date(Date_Time, unit = "minute")
  ) %>%
  arrange(Date_Time) %>%
  filter(!Size_frac %in% c("Ch1", "Ch2")) %>%
  mutate(
    Size_frac = recode(Size_frac, "Ch3" = "1-3um", "Ch4" = "3-5um", "Ch5" = "5-10um", "Ch6" = "10-14um"),
    bio_per_l = bio / Vol_L,
    Date = floor_date(Date_Time, unit = "day")
  )

write_tsv(biotrack_combined, here(derived_dir, "biotrack_combined.tsv"))
```

```{r biotrack-day-night}
sun_table <- biotrack_combined %>%
  distinct(Date) %>%
  mutate(lat = 56.0976, lon = 13.4189, date = as.Date(Date)) %>%
  suncalc::getSunlightTimes(data = .) %>%
  transmute(
    Date = date,
    sunrise = hms::as_hms(sunrise),
    sunset = hms::as_hms(sunset)
  )

biotrack_plot_data <- biotrack_combined %>%
  left_join(sun_table, by = "Date") %>%
  mutate(
    HMS = hms::as_hms(Date_Time),
    daytime = case_when(
      HMS < sunrise ~ "night",
      HMS >= sunrise & HMS < sunset ~ "day",
      HMS >= sunset ~ "night",
      TRUE ~ NA_character_
    )
  ) %>%
  group_by(season, Size_frac) %>%
  mutate(
    bio_h = rollapply(bio_per_l, width = 60, FUN = mean, na.rm = TRUE, fill = NA, partial = TRUE),
    bio_day = rollapply(bio_per_l, width = 720, FUN = mean, na.rm = TRUE, fill = NA, partial = FALSE)
  ) %>%
  ungroup()

biotrack_daynight_blocks <- biotrack_plot_data %>%
  filter(!is.na(daytime)) %>%
  arrange(Date_Time) %>%
  mutate(group = cumsum(daytime != lag(daytime, default = first(daytime)))) %>%
  group_by(group, daytime) %>%
  summarise(start = min(Date_Time), end = max(Date_Time), .groups = "drop") %>%
  filter(end > start)

biotrack_time_plot <- biotrack_plot_data %>%
  ggplot(aes(Date_Time)) +
  geom_rect(
    data = biotrack_daynight_blocks,
    aes(xmin = start, xmax = end, ymin = 0.001, ymax = 500, fill = daytime),
    inherit.aes = FALSE,
    alpha = 0.2
  ) +
  geom_line(aes(y = bio_h, colour = Size_frac), linewidth = 0.6) +
  facet_wrap(~season, scales = "free_x", nrow = 2) +
  scale_y_log10() +
  scale_fill_manual(values = c("day" = "#FDC500", "night" = "#00296B")) +
  labs(y = "Bioaerosol concentration per L", x = NULL, fill = NULL)

biotrack_time_plot

ggsave(here(fig_dir, "figure_biotrack_time_series.png"), biotrack_time_plot, width = 10, height = 5, dpi = 300)
```

## 12) Match NGI size fractions with Biotrack classes

We use a precomputed match table if present; otherwise we build it from the time windows.

```{r match-ngi-biotrack}
if (!is.null(matched_dna_biotrack_existing)) {
  matched_dna_biotrack <- matched_dna_biotrack_existing
} else {
  ngi_biotrack <- sample_metadata %>%
    filter(Type == "NGI") %>%
    fuzzy_left_join(
      biotrack_combined,
      by = c("Start_Date" = "Date_Time", "End_Date" = "Date_Time"),
      match_fun = list(`<=`, `>=`)
    ) %>%
    group_by(Sample, Size_frac) %>%
    summarise(bio = sum(bio, na.rm = TRUE), .groups = "drop")

  matched_dna_biotrack <- ngi_biotrack %>%
    pivot_wider(names_from = Size_frac, values_from = bio) %>%
    mutate(Ch5_6 = `5-10um` + `10-14um`) %>%
    select(Sample, `1-3um`, `3-5um`, Ch5_6) %>%
    pivot_longer(-Sample, names_to = "BT_Size_frac", values_to = "count") %>%
    left_join(sample_metadata %>% select(Sample, SizeFrac), by = "Sample") %>%
    mutate(
      match = case_when(
        SizeFrac %in% c("8.83", "4.89") & BT_Size_frac == "Ch5_6" ~ TRUE,
        SizeFrac == "3.09" & BT_Size_frac == "3-5um" ~ TRUE,
        SizeFrac %in% c("1.82", "1.03") & BT_Size_frac == "1-3um" ~ TRUE,
        TRUE ~ FALSE
      )
    ) %>%
    filter(match)

  write_tsv(matched_dna_biotrack, path_matched)
}

write_tsv(matched_dna_biotrack, here(derived_dir, "matched_dna_biotrack.tsv"))

matched_dna_biotrack
```

```{r biotrack-dna-richness-plots}
plot_dna_vs_biotrack <- matched_dna_biotrack %>%
  left_join(dna_concentration, by = "Sample") %>%
  left_join(sample_metadata, by = "Sample") %>%
  ggplot(aes(log10(count), DNA_C, colour = SizeFrac)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2) +
  labs(x = "log10(Biotrack count)", y = "DNA concentration") +
  scale_color_brewer(palette = "Set1")

plot_dna_vs_biotrack

ggsave(here(fig_dir, "figure_biotrack_vs_dna.png"), plot_dna_vs_biotrack, width = 6, height = 4, dpi = 300)

plot_richness_vs_biotrack <- matched_dna_biotrack %>%
  left_join(diversity_estimates, by = "Sample") %>%
  filter(!is.na(phylum), phylum != "Chordata") %>%
  left_join(sample_metadata, by = "Sample") %>%
  ggplot(aes(count, qD, colour = SizeFrac)) +
  geom_point(alpha = 0.8, size = 0.8) +
  facet_grid(phylum ~ season, scales = "free_y") +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Biotrack count", y = "OTU richness") +
  scale_color_brewer(palette = "Set1")

plot_richness_vs_biotrack

ggsave(here(fig_dir, "figure_biotrack_vs_richness.png"), plot_richness_vs_biotrack, width = 7, height = 6, dpi = 300)
```

## 13) HighVol comparison (if HighVol metadata are available)

This part is optional and only runs if HighVol samples exist in metadata.

```{r highvol-optional}
if (any(sample_metadata$Type == "HighVol")) {
  highvol_biotrack <- sample_metadata %>%
    filter(Type == "HighVol") %>%
    filter(!str_detect(Sample, "-")) %>%
    fuzzy_left_join(
      biotrack_combined,
      by = c("Start_Date" = "Date_Time", "End_Date" = "Date_Time"),
      match_fun = list(`<=`, `>=`)
    ) %>%
    group_by(Sample, Size_frac) %>%
    summarise(bio = sum(bio, na.rm = TRUE), all_count = sum(all, na.rm = TRUE), .groups = "drop")

  highvol_match <- highvol_biotrack %>%
    select(-all_count) %>%
    pivot_wider(names_from = Size_frac, values_from = bio) %>%
    mutate(sum_count = `1-3um` + `3-5um` + `5-10um`) %>%
    select(Sample, sum_count) %>%
    left_join(sample_metadata, by = "Sample")

  write_tsv(highvol_match, here(derived_dir, "highvol_biotrack_match.tsv"))

  highvol_dna_plot <- highvol_match %>%
    left_join(dna_concentration, by = "Sample") %>%
    ggplot(aes(sum_count, DNA_C, colour = season)) +
    geom_point() +
    scale_x_log10() +
    labs(x = "Biotrack summed count", y = "DNA concentration")

  ggsave(here(fig_dir, "figure_highvol_biotrack_vs_dna.png"), highvol_dna_plot, width = 6, height = 4, dpi = 300)
} else {
  message("No HighVol samples in current metadata. Skipping HighVol section.")
}
```

## 14) Weather summaries

We clean weather inputs and make a simple wind-direction summary plot.

```{r weather-clean}
weather_30m <- weather_30m_raw %>%
  select(Year, Month, Day, Hour, AT, RH, WS, WD) %>%
  mutate(date = ymd(paste(Year, Month, Day)))

precip_htm <- precip_raw %>%
  select(date, time, P_1_1_1, Swin_1_2_1, Lwin_1_2_1, Sun_1_1_1, RH_1_1_1, Ta_1_1_1) %>%
  setNames(c("date", "time", "precipitation", "radiation_SW", "radiation_LW", "sunshine_frac", "RH", "Temp")) %>%
  slice(-1) %>%
  mutate(across(-c(date, time), as.numeric))

write_tsv(weather_30m, here(derived_dir, "weather_30m_clean.tsv"))
write_tsv(precip_htm, here(derived_dir, "precipitation_clean.tsv"))
```

```{r weather-wind-rose}
wind_rose_df <- weather_30m %>%
  filter(WS > 0, WS < 12) %>%
  mutate(
    WS = round(WS),
    WD = cut_interval(WD, 8),
    WD = factor(WD, labels = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))
  ) %>%
  count(Month, WS, WD, name = "freq")

write_tsv(wind_rose_df, here(derived_dir, "wind_rose_counts.tsv"))

wind_rose_plot <- wind_rose_df %>%
  ggplot(aes(WD, freq, fill = WS)) +
  geom_col() +
  coord_polar(start = -0.4) +
  scale_fill_viridis_c() +
  facet_wrap(~Month)

wind_rose_plot

ggsave(here(fig_dir, "figure_wind_rose_by_month.png"), wind_rose_plot, width = 8, height = 6, dpi = 300)
```

## 15) Dry deposition trajectories

We calculate a simple size-dependent dry deposition trajectory over 72 hours.

```{r deposition}
colnames(deposition_raw) <- c("size", "speed", "distance")

deposition_over_time <- deposition_raw %>%
  transmute(
    size = as.character(size),
    settling_speed = as.numeric(speed)
  ) %>%
  distinct() %>%
  tidyr::crossing(sec = seq(0, 72 * 3600, 3600)) %>%
  mutate(
    hours = sec / 3600,
    distance_m = pmin(settling_speed * sec / 1e6, 100),
    wind_distance_km = sec * 5 / 1000
  )

write_tsv(deposition_over_time, here(derived_dir, "deposition_over_time.tsv"))

deposition_plot <- deposition_over_time %>%
  ggplot(aes(hours, distance_m, colour = factor(size), group = size)) +
  geom_line() +
  labs(
    x = "Time (hours)",
    y = "Settling distance (m)",
    colour = "Particle size"
  )

ggsave(here(fig_dir, "figure_dry_deposition_over_time.png"), deposition_plot, width = 7, height = 4, dpi = 300)

deposition_wind_plot <- deposition_over_time %>%
  ggplot(aes(wind_distance_km, distance_m, colour = factor(size), group = size)) +
  geom_line() +
  labs(
    x = "Horizontal travel distance at 5 m/s wind (km)",
    y = "Settling distance (m)",
    colour = "Particle size"
  )

ggsave(here(fig_dir, "figure_dry_deposition_with_wind.png"), deposition_wind_plot, width = 7, height = 4, dpi = 300)
```

## 16) Session information

```{r session-info}
sessionInfo()
```
